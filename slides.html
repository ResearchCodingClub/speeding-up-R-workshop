<!DOCTYPE html>
<html lang="en"><head>
<script src="slides_files/libs/clipboard/clipboard.min.js"></script>
<script src="slides_files/libs/quarto-html/tabby.min.js"></script>
<script src="slides_files/libs/quarto-html/popper.min.js"></script>
<script src="slides_files/libs/quarto-html/tippy.umd.min.js"></script>
<link href="slides_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="slides_files/libs/quarto-html/light-border.css" rel="stylesheet">
<link href="slides_files/libs/quarto-html/quarto-html.min.css" rel="stylesheet" data-mode="light">
<link href="slides_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.3.361">

  <meta name="author" content="Stuart Lacy">
  <meta name="dcterms.date" content="2023-06-28">
  <title>Speeding up R</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="slides_files/libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="slides_files/libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="slides_files/libs/revealjs/dist/theme/quarto.css">
  <link href="slides_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="slides_files/libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="slides_files/libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="slides_files/libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">

  .callout {
    margin-top: 1em;
    margin-bottom: 1em;  
    border-radius: .25rem;
  }

  .callout.callout-style-simple { 
    padding: 0em 0.5em;
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
    display: flex;
  }

  .callout.callout-style-default {
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
  }

  .callout .callout-body-container {
    flex-grow: 1;
  }

  .callout.callout-style-simple .callout-body {
    font-size: 1rem;
    font-weight: 400;
  }

  .callout.callout-style-default .callout-body {
    font-size: 0.9rem;
    font-weight: 400;
  }

  .callout.callout-titled.callout-style-simple .callout-body {
    margin-top: 0.2em;
  }

  .callout:not(.callout-titled) .callout-body {
      display: flex;
  }

  .callout:not(.no-icon).callout-titled.callout-style-simple .callout-content {
    padding-left: 1.6em;
  }

  .callout.callout-titled .callout-header {
    padding-top: 0.2em;
    margin-bottom: -0.2em;
  }

  .callout.callout-titled .callout-title  p {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }
    
  .callout.callout-titled.callout-style-simple .callout-content  p {
    margin-top: 0;
  }

  .callout.callout-titled.callout-style-default .callout-content  p {
    margin-top: 0.7em;
  }

  .callout.callout-style-simple div.callout-title {
    border-bottom: none;
    font-size: .9rem;
    font-weight: 600;
    opacity: 75%;
  }

  .callout.callout-style-default  div.callout-title {
    border-bottom: none;
    font-weight: 600;
    opacity: 85%;
    font-size: 0.9rem;
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-default div.callout-content {
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-simple .callout-icon::before {
    height: 1rem;
    width: 1rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 1rem 1rem;
  }

  .callout.callout-style-default .callout-icon::before {
    height: 0.9rem;
    width: 0.9rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 0.9rem 0.9rem;
  }

  .callout-title {
    display: flex
  }
    
  .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  .callout.no-icon::before {
    display: none !important;
  }

  .callout.callout-titled .callout-body > .callout-content > :last-child {
    margin-bottom: 0.5rem;
  }

  .callout.callout-titled .callout-icon::before {
    margin-top: .5rem;
    padding-right: .5rem;
  }

  .callout:not(.callout-titled) .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  /* Callout Types */

  div.callout-note {
    border-left-color: #4582ec !important;
  }

  div.callout-note .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEU0lEQVRYCcVXTWhcVRQ+586kSUMMxkyaElstCto2SIhitS5Ek8xUKV2poatCcVHtUlFQk8mbaaziwpWgglJwVaquitBOfhQXFlqlzSJpFSpIYyXNjBNiTCck7x2/8/LeNDOZxDuEkgOXe++553zfefee+/OYLOXFk3+1LLrRdiO81yNqZ6K9cG0P3MeFaMIQjXssE8Z1JzLO9ls20MBZX7oG8w9GxB0goaPrW5aNMp1yOZIa7Wv6o2ykpLtmAPs/vrG14Z+6d4jpbSKuhdcSyq9wGMPXjonwmESXrriLzFGOdDBLB8Y6MNYBu0dRokSygMA/mrun8MGFN3behm6VVAwg4WR3i6FvYK1T7MHo9BK7ydH+1uurECoouk5MPRyVSBrBHMYwVobG2aOXM07sWrn5qgB60rc6mcwIDJtQrnrEr44kmy+UO9r0u9O5/YbkS9juQckLed3DyW2XV/qWBBB3ptvI8EUY3I9p/67OW+g967TNr3Sotn3IuVlfMLVnsBwH4fsnebJvyGm5GeIUA3jljERmrv49SizPYuq+z7c2H/jlGC+Ghhupn/hcapqmcudB9jwJ/3jvnvu6vu5lVzF1fXyZuZZ7U8nRmVzytvT+H3kilYvH09mLWrQdwFSsFEsxFVs5fK7A0g8gMZjbif4ACpKbjv7gNGaD8bUrlk8x+KRflttr22JEMRUbTUwwDQScyzPgedQHZT0xnx7ujw2jfVfExwYHwOsDTjLdJ2ebmeQIlJ7neo41s/DrsL3kl+W2lWvAga0tR3zueGr6GL78M3ifH0rGXrBC2aAR8uYcIA5gwV8zIE8onoh8u0Fca/ciF7j1uOzEnqcIm59sEXoGc0+z6+H45V1CvAvHcD7THztu669cnp+L0okAeIc6zjbM/24LgGM1gZk7jnRu1aQWoU9sfUOuhrmtaPIO3YY1KLLWZaEO5TKUbMY5zx8W9UJ6elpLwKXbsaZ4EFl7B4bMtDv0iRipKoDQT2sNQI9b1utXFdYisi+wzZ/ri/1m7QfDgEuvgUUEIJPq3DhX/5DWNqIXDOweC2wvIR90Oq3lDpdMIgD2r0dXvGdsEW5H6x6HLRJYU7C69VefO1x8Gde1ZFSJLfWS1jbCnhtOPxmpfv2LXOA2Xk2tvnwKKPFuZ/oRmwBwqRQDcKNeVQkYcOjtWVBuM/JuYw5b6isojIkYxyYAFn5K7ZBF10fea52y8QltAg6jnMqNHFBmGkQ1j+U43HMi2xMar1Nv0zGsf1s8nUsmUtPOOrbFIR8bHFDMB5zL13Gmr/kGlCkUzedTzzmzsaJXhYawnA3UmARpiYj5ooJZiUoxFRtK3X6pgNPv+IZVPcnwbOl6f+aBaO1CNvPW9n9LmCp01nuSaTRF2YxHqZ8DYQT6WsXT+RD6eUztwYLZ8rM+rcPxamv1VQzFUkzFXvkiVrySGQgJNvXHJAxiU3/NwiC03rSf05VBaPtu/Z7/B8Yn/w7eguloAAAAAElFTkSuQmCC');
  }

  div.callout-note.callout-style-default .callout-title {
    background-color: #dae6fb
  }

  div.callout-important {
    border-left-color: #d9534f !important;
  }

  div.callout-important .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEKklEQVRYCcVXTWhcVRS+575MJym48A+hSRFr00ySRQhURRfd2HYjk2SSTokuBCkU2o0LoSKKraKIBTcuFCoidGFD08nkBzdREbpQ1EDNIv8qSGMFUboImMSZd4/f9zJv8ibJMC8xJQfO3HPPPef7zrvvvnvviIkpC9nsw0UttFunbUhpFzFtarSd6WJkStVMw5xyVqYTvkwfzuf/5FgtkVoB0729j1rjXwThS7Vio+Mo6DNnvLfahoZ+i/o32lULuJ3NNiz7q6+pyAUkJaFF6JwaM2lUJlV0MlnQn5aTRbEu0SEqHUa0A4AdiGuB1kFXRfVyg5d87+Dg4DL6m2TLAub60ilj7A1Ec4odSAc8X95sHh7+ZRPCFo6Fnp7HfU/fBng/hi10CjCnWnJjsxvDNxWw0NfV6Rv5GgP3I3jGWXumdTD/3cbEOP2ZbOZp69yniG3FQ9z1jD7bnBu9Fc2tKGC2q+uAJOQHBDRiZX1x36o7fWBs7J9ownbtO+n0/qWkvW7UPIfc37WgT6ZGR++EOJyeQDSb9UB+DZ1G6DdLDzyS+b/kBCYGsYgJbSQHuThGKRcw5xdeQf8YdNHsc6ePXrlSYMBuSIAFTGAtQo+VuALo4BX83N190NWZWbynBjhOHsmNfFWLeL6v+ynsA58zDvvAC8j5PkbOcXCMg2PZFk3q8MjI7WAG/Dp9AwP7jdGBOOQkAvlFUB+irtm16I1Zw9YBcpGTGXYmk3kQIC/Cds55l+iMI3jqhjAuaoe+am2Jw5GT3Nbz3CkE12NavmzN5+erJW7046n/CH1RO/RVa8lBLozXk9uqykkGAyRXLWlLv5jyp4RFsG5vGVzpDLnIjTWgnRy2Rr+tDKvRc7Y8AyZq10jj8DqXdnIRNtFZb+t/ZRtXcDiVnzpqx8mPcDWxgARUqx0W1QB9MeUZiNrV4qP+Ehc+BpNgATsTX8ozYKL2NtFYAHc84fG7ndxUPr+AR/iQSns7uSUufAymwDOb2+NjK27lEFocm/EE2WpyIy/Hi66MWuMKJn8RvxIcj87IM5Vh9663ziW36kR0HNenXuxmfaD8JC7tfKbrhFr7LiZCrMjrzTeGx+PmkosrkNzW94ObzwocJ7A1HokLolY+AvkTiD/q1H0cN48c5EL8Crkttsa/AXQVDmutfyku0E7jShx49XqV3MFK8IryDhYVbj7Sj2P2eBxwcXoe8T8idsKKPRcnZw1b+slFTubwUwhktrfnAt7J++jwQtLZcm3sr9LQrjRzz6cfMv9aLvgmnAGvpoaGLxM4mAEaLV7iAzQ3oU0IvD5x9ix3yF2RAAuYAOO2f7PEFWCXZ4C9Pb2UsgDeVnFSpbFK7/IWu7TPTvBqzbGdCHOJQSxiEjt6IyZmxQyEJHv6xyQsYk//moVFsN2zP6fRImjfq7/n/wFDguUQFNEwugAAAABJRU5ErkJggg==');
  }

  div.callout-important.callout-style-default .callout-title {
    background-color: #f7dddc
  }

  div.callout-warning {
    border-left-color: #f0ad4e !important;
  }

  div.callout-warning .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAETklEQVRYCeVWW2gcVRg+58yaTUnizqbipZeX4uWhBEniBaoUX1Ioze52t7sRq6APio9V9MEaoWlVsFasRq0gltaAPuxms8lu0gcviE/FFOstVbSIxgcv6SU7EZqmdc7v9+9mJtNks51NTUH84ed889/PP+cmxP+d5FIbMJmNbpREu4WUkiTtCicKny0l1pIKmBzovF2S+hIJHX8iEu3hZJ5lNZGqyRrGSIQpq15AzF28jgpeY6yk6GVdrfFqdrD6Iw+QlB8g0YS2g7dyQmXM/IDhBhT0UCiRf59lfqmmDvzRt6kByV/m4JjtzuaujMUM2c5Z2d6JdKrRb3K2q6mA+oYVz8JnDdKPmmNthzkAk/lN63sYPgevrguc72aZX/L9C6x09GYyxBgCX4NlvyGUHOKELlm5rXeR1kchuChJt4SSwyddZRXgvwMGvYo4QSlk3/zkHD8UHxwVJA6zjZZqP8v8kK8OWLnIZtLyCAJagYC4rTGW/9Pqj92N/c+LUaAj27movwbi19tk/whRCIE7Q9vyI6yvRpftAKVTdUjOW40X3h5OXsKCdmFcx0xlLJoSuQngnrJe7Kcjm4OMq9FlC7CMmScQANuNvjfP3PjGXDBaUQmbp296S5L4DrpbrHN1T87ZVEZVCzg1FF0Ft+dKrlLukI+/c9ENo+TvlTDbYFvuKPtQ9+l052rXrgKoWkDAFnvh0wTOmYn8R5f4k/jN/fZiCM1tQx9jQQ4ANhqG4hiL0qIFTGViG9DKB7GYzgubnpofgYRwO+DFjh0Zin2m4b/97EDkXkc+f6xYAPX0KK2I/7fUQuwzuwo/L3AkcjugPNixC8cHf0FyPjWlItmLxWw4Ou9YsQCr5fijMGoD/zpdRy95HRysyXA74MWOnscpO4j2y3HAVisw85hX5+AFBRSHt4ShfLFkIMXTqyKFc46xdzQM6XbAi702a7sy04J0+feReMFKp5q9esYLCqAZYw/k14E/xcLLsFElaornTuJB0svMuJINy8xkIYuL+xPAlWRceH6+HX7THJ0djLUom46zREu7tTkxwmf/FdOZ/sh6Q8qvEAiHpm4PJ4a/doJe0gH1t+aHRgCzOvBvJedEK5OFE5jpm4AGP2a8Dxe3gGJ/pAutug9Gp6he92CsSsWBaEcxGx0FHytmIpuqGkOpldqNYQK8cSoXvd+xLxXADw0kf6UkJNFtdo5MOgaLjiQOQHcn+A6h5NuL2s0qsC2LOM75PcF3yr5STuBSAcGG+meA14K/CI21HcS4LBT6tv0QAh8Dr5l93AhZzG5ZJ4VxAqdZUEl9z7WJ4aN+svMvwHHL21UKTd1mqvChH7/Za5xzXBBKrUcB0TQ+Ulgkfbi/H/YT5EptrGzsEK7tR1B7ln9BBwckYfMiuSqklSznIuoIIOM42MQO+QnduCoFCI0bpkzjCjddHPN/F+2Yu+sd9bKNpVwHhbS3LluK/0zgfwD0xYI5dXuzlQAAAABJRU5ErkJggg==');
  }

  div.callout-warning.callout-style-default .callout-title {
    background-color: #fcefdc
  }

  div.callout-tip {
    border-left-color: #02b875 !important;
  }

  div.callout-tip .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAADr0lEQVRYCe1XTWgTQRj9ZjZV8a9SPIkKgj8I1bMHsUWrqYLVg4Ue6v9BwZOxSYsIerFao7UiUryIqJcqgtpimhbBXoSCVxUFe9CTiogUrUp2Pt+3aUI2u5vdNh4dmMzOzHvvezuz8xNFM0mjnbXaNu1MvFWRXkXEyE6aYOYJpdW4IXuA4r0fo8qqSMDBU0v1HJUgVieAXxzCsdE/YJTdFcVIZQNMyhruOMJKXYFoLfIfIvVIMWdsrd+Rpd86ZmyzzjJmLStqRn0v8lzkb4rVIXvnpScOJuAn2ACC65FkPzEdEy4TPWRLJ2h7z4cArXzzaOdKlbOvKKX25Wl00jSnrwVxAg3o4dRxhO13RBSdNvH0xSARv3adTXbBdTf64IWO2vH0LT+cv4GR1DJt+DUItaQogeBX/chhbTBxEiZ6gftlDNXTrvT7co4ub5A6gp9HIcHvzTa46OS5fBeP87Qm0fQkr4FsYgVQ7Qg+ZayaDg9jhg1GkWj8RG6lkeSacrrHgDaxdoBiZPg+NXV/KifMuB6//JmYH4CntVEHy/keA6x4h4CU5oFy8GzrBS18cLJMXcljAKB6INjWsRcuZBWVaS3GDrqB7rdapVIeA+isQ57Eev9eCqzqOa81CY05VLd6SamW2wA2H3SiTbnbSxmzfp7WtKZkqy4mdyAlGx7ennghYf8voqp9cLSgKdqNfa6RdRsAAkPwRuJZNbpByn+RrJi1RXTwdi8RQF6ymDwGMAtZ6TVE+4uoKh+MYkcLsT0Hk8eAienbiGdjJHZTpmNjlbFJNKDVAp2fJlYju6IreQxQ08UJDNYdoLSl6AadO+fFuCQqVMB1NJwPm69T04Wv5WhfcWyfXQB+wXRs1pt+nCknRa0LVzSA/2B+a9+zQJadb7IyyV24YAxKp2Jqs3emZTuNnKxsah+uabKbMk7CbTgJx/zIgQYErIeTKRQ9yD9wxVof5YolPHqaWo7TD6tJlh7jQnK5z2n3+fGdggIOx2kaa2YI9QWarc5Ce1ipNWMKeSG4DysFF52KBmTNMmn5HqCFkwy34rDg05gDwgH3bBi+sgFhN/e8QvRn8kbamCOhgrZ9GJhFDgfcMHzFb6BAtjKpFhzTjwv1KCVuxHvCbsSiEz4CANnj84cwHdFXAbAOJ4LTSAawGWFn5tDhLMYz6nWeU2wJfIhmIJBefcd/A5FWQWGgrWzyORZ3Q6HuV+Jf0Bj+BTX69fm1zWgK7By1YTXchFDORywnfQ7GpzOo6S+qECrsx2ifVQAAAABJRU5ErkJggg==');
  }

  div.callout-tip.callout-style-default .callout-title {
    background-color: #ccf1e3
  }

  div.callout-caution {
    border-left-color: #fd7e14 !important;
  }

  div.callout-caution .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAACV0lEQVRYCdVWzWoUQRCuqp2ICBLJXgITZL1EfQDBW/bkzUMUD7klD+ATSHBEfAIfQO+iXsWDxJsHL96EHAwhgzlkg8nBg25XWb0zIb0zs9muYYWkoKeru+vn664fBqElyZNuyh167NXJ8Ut8McjbmEraKHkd7uAnAFku+VWdb3reSmRV8PKSLfZ0Gjn3a6Xlcq9YGb6tADjn+lUfTXtVmaZ1KwBIvFI11rRXlWlatwIAAv2asaa9mlB9wwygiDX26qaw1yYPzFXg2N1GgG0FMF8Oj+VIx7E/03lHx8UhvYyNZLN7BwSPgekXXLribw7w5/c8EF+DBK5idvDVYtEEwMeYefjjLAdEyQ3M9nfOkgnPTEkYU+sxMq0BxNR6jExrAI31H1rzvLEfRIdgcv1XEdj6QTQAS2wtstEALLG1yEZ3QhH6oDX7ExBSFEkFINXH98NTrme5IOaaA7kIfiu2L8A3qhH9zRbukdCqdsA98TdElyeMe5BI8Rs2xHRIsoTSSVFfCFCWGPn9XHb4cdobRIWABNf0add9jakDjQJpJ1bTXOJXnnRXHRf+dNL1ZV1MBRCXhMbaHqGI1JkKIL7+i8uffuP6wVQAzO7+qVEbF6NbS0LJureYcWXUUhH66nLR5rYmva+2tjRFtojkM2aD76HEGAD3tPtKM309FJg5j/K682ywcWJ3PASCcycH/22u+Bh7Aa0ehM2Fu4z0SAE81HF9RkB21c5bEn4Dzw+/qNOyXr3DCTQDMBOdhi4nAgiFDGCinIa2owCEChUwD8qzd03PG+qdW/4fDzjUMcE1ZpIAAAAASUVORK5CYII=');
  }

  div.callout-caution.callout-style-default .callout-title {
    background-color: #ffe5d0
  }

  </style>
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
  
  <script src="slides_files/libs/kePrint-0.0.1/kePrint.js"></script>
  <link href="slides_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">Speeding up R</h1>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
Stuart Lacy 
</div>
</div>
</div>

  <p class="date">2023-06-28</p>
</section>
<section id="introduction" class="slide level2">
<h2>Introduction</h2>
<ul>
<li>Focus on techniques for speeding up analysis of tabular data</li>
<li>Subjects:
<ul>
<li>Vectorization</li>
<li>Joins</li>
<li><code>Rcpp</code></li>
<li><code>data.table</code></li>
<li>Alternative backends</li>
</ul></li>
</ul>
</section>
<section>
<section id="vectorization" class="title-slide slide level1 center">
<h1>Vectorization</h1>

</section>
<section id="vectorization-concept" class="slide level2">
<h2>Vectorization Concept</h2>
<blockquote>
<p>For loops in R are slow - many StackOverflow posts</p>
</blockquote>
<ul>
<li>In general, if you’re using a <code>for</code> loop (or a <code>sapply</code> variant), then your code could be sped up by using a <code>vectorised</code> function</li>
<li>Definition: <code>f(x[i]) = f(x)[i]</code> for <span class="math inline">\(i \in 1, ..., N\)</span></li>
</ul>
<div class="fragment">
<ul>
<li><code>sqrt(c(4, 9, 16)) = 2, 3, 4</code>, therefore <code>sqrt</code> is vectorised</li>
<li>Using vectorised functions often results in <strong>cleaner code</strong> with less chance for bugs</li>
<li>There are a lot of vectorised functions available in the standard library</li>
</ul>
</div>
</section>
<section id="standard-library-vectorised-functions" class="slide level2 smaller">
<h2>Standard library vectorised functions</h2>
<div class="columns">
<div class="column" style="width:50%;">
<ul>
<li>Non-vectorised</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df)) {</span>
<span id="cb1-2"><a href="#cb1-2"></a>  <span class="co"># New column based on 2 others</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>  <span class="cf">if</span> (df<span class="sc">$</span>x[i] <span class="sc">&gt;</span> <span class="dv">5</span> <span class="sc">&amp;&amp;</span> df<span class="sc">$</span>y[i] <span class="sc">&lt;</span> <span class="dv">0</span>) {</span>
<span id="cb1-4"><a href="#cb1-4"></a>    df<span class="sc">$</span>y[i] <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>  } <span class="cf">else</span> {</span>
<span id="cb1-6"><a href="#cb1-6"></a>    df<span class="sc">$</span>y[i] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>  }</span>
<span id="cb1-8"><a href="#cb1-8"></a>  </span>
<span id="cb1-9"><a href="#cb1-9"></a>  <span class="co"># Replace NAs with error code</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(df<span class="sc">$</span>z[i])) {</span>
<span id="cb1-11"><a href="#cb1-11"></a>    df<span class="sc">$</span>z[i] <span class="ot">&lt;-</span> <span class="dv">9999</span> </span>
<span id="cb1-12"><a href="#cb1-12"></a>  }</span>
<span id="cb1-13"><a href="#cb1-13"></a>  </span>
<span id="cb1-14"><a href="#cb1-14"></a>  <span class="co"># String concatenate columns</span></span>
<span id="cb1-15"><a href="#cb1-15"></a>  df<span class="sc">$</span>xy[i] <span class="ot">&lt;-</span> <span class="fu">paste</span>(df<span class="sc">$</span>x[i], df<span class="sc">$</span>y[i], <span class="at">sep=</span><span class="st">"_"</span>)</span>
<span id="cb1-16"><a href="#cb1-16"></a>}</span>
<span id="cb1-17"><a href="#cb1-17"></a>  </span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="co"># Distance between every row</span></span>
<span id="cb1-19"><a href="#cb1-19"></a>dists <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow=</span><span class="fu">nrow</span>(df), <span class="at">ncol=</span><span class="fu">nrow</span>(df))</span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df)) {</span>
<span id="cb1-21"><a href="#cb1-21"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df)) {</span>
<span id="cb1-22"><a href="#cb1-22"></a>    <span class="cf">if</span> (j <span class="sc">!=</span> i) {</span>
<span id="cb1-23"><a href="#cb1-23"></a>      dists[i, j] <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((df<span class="sc">$</span>x[i] <span class="sc">-</span> df<span class="sc">$</span>x[j])<span class="sc">**</span><span class="dv">2</span> <span class="sc">+</span> (df<span class="sc">$</span>y[i] <span class="sc">-</span> df<span class="sc">$</span>y[j])<span class="sc">**</span><span class="dv">2</span>)</span>
<span id="cb1-24"><a href="#cb1-24"></a>    }</span>
<span id="cb1-25"><a href="#cb1-25"></a>  }</span>
<span id="cb1-26"><a href="#cb1-26"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div><div class="column" style="width:50%;">
<ul>
<li>Vectorised</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co"># New column based on 2 others</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>df<span class="sc">$</span>y <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(df<span class="sc">$</span>x <span class="sc">&gt;</span> <span class="dv">5</span> <span class="sc">&amp;</span> df<span class="sc">$</span>y <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">0</span>)</span>
<span id="cb2-4"><a href="#cb2-4"></a></span>
<span id="cb2-5"><a href="#cb2-5"></a></span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a></span>
<span id="cb2-8"><a href="#cb2-8"></a></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="co"># Replace NAs with error code</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>df<span class="sc">$</span>z[<span class="fu">is.na</span>(df<span class="sc">$</span>z)] <span class="ot">&lt;-</span> <span class="dv">9999</span></span>
<span id="cb2-11"><a href="#cb2-11"></a></span>
<span id="cb2-12"><a href="#cb2-12"></a></span>
<span id="cb2-13"><a href="#cb2-13"></a></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="co"># Concatenate columns</span></span>
<span id="cb2-15"><a href="#cb2-15"></a>df<span class="sc">$</span>xy <span class="ot">&lt;-</span> <span class="fu">paste</span>(df<span class="sc">$</span>x, df<span class="sc">$</span>y, <span class="at">sep=</span><span class="st">"_"</span>)</span>
<span id="cb2-16"><a href="#cb2-16"></a></span>
<span id="cb2-17"><a href="#cb2-17"></a></span>
<span id="cb2-18"><a href="#cb2-18"></a><span class="co"># Distance between every row</span></span>
<span id="cb2-19"><a href="#cb2-19"></a><span class="fu">dist</span>(df[, <span class="fu">c</span>(<span class="st">'x'</span>, <span class="st">'y'</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="worked-example" class="slide level2">
<h2>Worked example</h2>
<ul>
<li>Example taken from <a href="https://www.jimhester.com/post/2018-04-12-vectorize/">Jim Hester’s blog post</a></li>
</ul>
<blockquote>
<p>Given a path some/path/abc/001.txt, create a fast function to return abc_001.txt</p>
</blockquote>
<div class="fragment">
<ul>
<li>First attempt works on a single path at a time, separating it by <code>/</code> and concatenating the last directory and filename</li>
<li>Doesn’t work for a vector input, is there an easy way to vectorise it?</li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/string-1_7920124f2b1c52f749d9f5cf1692218a">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>example_1 <span class="ot">&lt;-</span> <span class="cf">function</span>(path) {</span>
<span id="cb3-2"><a href="#cb3-2"></a>  path_list <span class="ot">&lt;-</span> <span class="fu">str_split</span>(path, <span class="st">"/"</span>) <span class="sc">%&gt;%</span> <span class="fu">unlist</span>()</span>
<span id="cb3-3"><a href="#cb3-3"></a>  <span class="fu">paste</span>(path_list[<span class="fu">length</span>(path_list) <span class="sc">-</span> <span class="dv">1</span>], path_list[<span class="fu">length</span>(path_list)], <span class="at">sep =</span> <span class="st">"_"</span>)</span>
<span id="cb3-4"><a href="#cb3-4"></a>}</span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="fu">example_1</span>(<span class="fu">c</span>(<span class="st">"foo/bar/car/001.txt"</span>, <span class="st">"har/far/lar/002.txt"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "lar_002.txt"</code></pre>
</div>
</div>
</div>
</section>
<section id="version-1---vectorize" class="slide level2">
<h2>Version 1 - <code>Vectorize</code></h2>
<ul>
<li><code>Vectorize</code> takes a function that works on a single element, and returns a vectorised version - job done!</li>
</ul>
<div class="fragment">
<ul>
<li>However, it just uses <code>apply</code> under the hood and <strong>isn’t quicker</strong>, mostly just syntatical sugar</li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/string-1-vec_82c0c0b15559b4d51015b6e9ebd7355e">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>example_1_vectorised <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(example_1)  <span class="co"># This returns a *function*</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="fu">example_1_vectorised</span>(<span class="fu">c</span>(<span class="st">"foo/bar/car/001.txt"</span>, <span class="st">"har/far/lar/002.txt"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>foo/bar/car/001.txt har/far/lar/002.txt 
      "car_001.txt"       "lar_002.txt" </code></pre>
</div>
</div>
</div>
</section>
<section id="version-2" class="slide level2">
<h2>Version 2</h2>
<ul>
<li>Want to replace this implicit for loop with inbuilt vectorised functions</li>
<li>✅ <code>str_split</code> is vectorised, returning a list over the input entries</li>
<li>✅ <code>paste</code> is also vectorised</li>
<li>❌ Need to use a for loop (<code>sapply</code>) to grab the last dir and filename from each entry</li>
<li>Overall have reduced the computation done inside the for loop</li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/string-2_d816ef7920027d8b9489b507edff7cc3">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>example_2 <span class="ot">&lt;-</span> <span class="cf">function</span>(paths) {</span>
<span id="cb7-2"><a href="#cb7-2"></a>  path_list <span class="ot">&lt;-</span> <span class="fu">str_split</span>(paths, <span class="st">"/"</span>)</span>
<span id="cb7-3"><a href="#cb7-3"></a>  last_two <span class="ot">&lt;-</span> <span class="fu">sapply</span>(path_list, tail, <span class="dv">2</span>)</span>
<span id="cb7-4"><a href="#cb7-4"></a>  <span class="fu">paste</span>(last_two[<span class="dv">1</span>, ], last_two[<span class="dv">2</span>, ], <span class="at">sep=</span><span class="st">"_"</span>)</span>
<span id="cb7-5"><a href="#cb7-5"></a>}</span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="fu">example_2</span>(<span class="fu">c</span>(<span class="st">"foo/bar/car/001.txt"</span>, <span class="st">"har/far/lar/002.txt"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "car_001.txt" "lar_002.txt"</code></pre>
</div>
</div>
</section>
<section id="version-3" class="slide level2">
<h2>Version 3</h2>
<ul>
<li>We can’t directly replace this for loop with a single vectorised function, have to take another approach</li>
<li><code>dirname('foo/bar/dog.txt') = foo/bar</code></li>
<li><code>basename('foo/bar/dog.txt') = dog.txt</code></li>
<li>Combining these can give us our entire functionality in 4 inbuilt vectorised function calls!</li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/string-3_1f4e44e776f48cff5fd5dee6ebad07ac">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>example_3 <span class="ot">&lt;-</span> <span class="cf">function</span>(paths) {</span>
<span id="cb9-2"><a href="#cb9-2"></a>  <span class="fu">paste</span>(<span class="fu">basename</span>(<span class="fu">dirname</span>(paths)), <span class="fu">basename</span>(paths), <span class="at">sep=</span><span class="st">"_"</span>)</span>
<span id="cb9-3"><a href="#cb9-3"></a>}</span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="fu">example_3</span>(<span class="fu">c</span>(<span class="st">"foo/bar/car/001.txt"</span>, <span class="st">"har/far/lar/002.txt"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "car_001.txt" "lar_002.txt"</code></pre>
</div>
</div>
</section>
<section id="comparison" class="slide level2">
<h2>Comparison</h2>
<ul>
<li>The <code>microbenchmark</code> library makes it easy to time snippets of code</li>
<li>The <code>Vectorize</code> version isn’t doing anything different from manually looping through with <code>sapply</code></li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/string-comp_347f8de9499fc41d71d83f46ee33390b">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="co"># Construct 100 paths</span></span>
<span id="cb11-3"><a href="#cb11-3"></a>paths <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"some/path/abc/001.txt"</span>, <span class="st">"another/directory/xyz/002.txt"</span>), <span class="dv">100</span>)</span>
<span id="cb11-4"><a href="#cb11-4"></a></span>
<span id="cb11-5"><a href="#cb11-5"></a>res <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(</span>
<span id="cb11-6"><a href="#cb11-6"></a>  <span class="fu">example_1_vectorised</span>(paths),</span>
<span id="cb11-7"><a href="#cb11-7"></a>  <span class="fu">sapply</span>(paths, example_1),</span>
<span id="cb11-8"><a href="#cb11-8"></a>  <span class="fu">example_2</span>(paths),</span>
<span id="cb11-9"><a href="#cb11-9"></a>  <span class="fu">example_3</span>(paths)</span>
<span id="cb11-10"><a href="#cb11-10"></a>)</span>
<span id="cb11-11"><a href="#cb11-11"></a></span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="fu">summary</span>(res)[<span class="fu">c</span>(<span class="st">"expr"</span>, <span class="st">"median"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                         expr   median
1 example_1_vectorised(paths) 6207.758
2    sapply(paths, example_1) 6086.460
3            example_2(paths) 1078.590
4            example_3(paths)  107.691</code></pre>
</div>
</div>
</section>
<section id="conclusions" class="slide level2 smaller">
<h2>Conclusions</h2>
<blockquote>
<p>In general, if you’re using a <code>for</code> loop (or a <code>sapply</code> variant), then your code could be sped up by using a <code>vectorised</code> function - Me (7 slides ago)</p>
</blockquote>
<ul>
<li>This wasn’t fully correct, as vectorised functions can have for loops under the hood and will thus still be slow</li>
<li>The difference between a vectorised function built using <code>Vectorize</code> or an inbuilt function like <code>basename</code> is that the latter will have a for loop, <strong>but it will be written in C/C++ rather than R</strong></li>
</ul>
<div class="fragment">
<blockquote>
<p>In general, if you’re using a <code>for</code> loop (or a <code>sapply</code> variant), then your code could be sped up by using a for loop written in C/C++, preferably part of the standard library - Me (now)</p>
</blockquote>
<ul>
<li>Later on will demonstrate how to write our own C++ functions</li>
</ul>
</div>
</section></section>
<section>
<section id="dataframes-joining" class="title-slide slide level1 center">
<h1>DataFrames &amp; Joining</h1>

</section>
<section id="basic-dataframe-operations" class="slide level2 smaller">
<h2>Basic DataFrame operations</h2>
<ul>
<li>Fortunately working with <code>data.frame</code>s and the <code>tidyverse</code> core verbs pushes you towards using vectorised functions</li>
<li><code>group_by() |&gt; summarise()</code> is both quicker and more legible than manually looping over the groups and combining the results</li>
<li><code>filter(f(x))</code> assumes that <code>f()</code> is vectorised and returns a boolean <code>TRUE/FALSE</code> for every row</li>
<li><code>mutate(newcol=f(oldcol))</code> assumes <code>f()</code> is vectorised and returns a value per row</li>
</ul>
<div class="fragment">
<ul>
<li><strong>Caution</strong>, can run into errors or unexpected behaviour if not using vectorised functions</li>
</ul>
<div class="columns">
<div class="column" style="width:50%;">
<div class="cell" data-hash="slides_cache/revealjs/string-error_2de242efc670815476ea594e475d9564">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="co"># Non-vectorised version didn't Error, </span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="co"># but gave an unexpected result</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="fu">data.frame</span>(<span class="at">path=</span>paths) <span class="sc">|&gt;</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>  <span class="fu">mutate</span>(<span class="at">path_clean1 =</span> <span class="fu">example_1</span>(path),</span>
<span id="cb13-5"><a href="#cb13-5"></a>         <span class="at">path_clean2 =</span> <span class="fu">example_3</span>(path)) <span class="sc">|&gt;</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>  <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                           path path_clean1 path_clean2
1         some/path/abc/001.txt xyz_002.txt abc_001.txt
2 another/directory/xyz/002.txt xyz_002.txt xyz_002.txt
3         some/path/abc/001.txt xyz_002.txt abc_001.txt
4 another/directory/xyz/002.txt xyz_002.txt xyz_002.txt
5         some/path/abc/001.txt xyz_002.txt abc_001.txt
6 another/directory/xyz/002.txt xyz_002.txt xyz_002.txt</code></pre>
</div>
</div>
</div><div class="column" style="width:50%;">
<div class="cell" data-hash="slides_cache/revealjs/string-ifelse_5374e799d3911bcca5a2d82140022768">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="co"># This function isn't vectorised due to the if/else statement</span></span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="co"># Solution: Use ifelse() instead</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>replace_both_NA_9999 <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb15-4"><a href="#cb15-4"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(x) <span class="sc">&amp;&amp;</span> <span class="fu">is.na</span>(y)) {</span>
<span id="cb15-5"><a href="#cb15-5"></a>    <span class="fu">return</span>(<span class="dv">9999</span>)</span>
<span id="cb15-6"><a href="#cb15-6"></a>  } <span class="cf">else</span> {</span>
<span id="cb15-7"><a href="#cb15-7"></a>    <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb15-8"><a href="#cb15-8"></a>  }</span>
<span id="cb15-9"><a href="#cb15-9"></a>}</span>
<span id="cb15-10"><a href="#cb15-10"></a></span>
<span id="cb15-11"><a href="#cb15-11"></a><span class="fu">data.frame</span>(<span class="at">a=</span><span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">3</span>, <span class="cn">NA</span>, <span class="dv">2</span>, <span class="cn">NA</span>), </span>
<span id="cb15-12"><a href="#cb15-12"></a>           <span class="at">b=</span><span class="fu">c</span>(<span class="cn">NA</span>, <span class="dv">2</span>, <span class="cn">NA</span>, <span class="dv">1</span>, <span class="dv">9</span>)) <span class="sc">|&gt;</span></span>
<span id="cb15-13"><a href="#cb15-13"></a>  <span class="fu">mutate</span>(<span class="at">c =</span> <span class="fu">replace_both_NA_9999</span>(a, b))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `mutate()`:
ℹ In argument: `c = replace_both_NA_9999(a, b)`.
Caused by error in `is.na(x) &amp;&amp; is.na(y)`:
! 'length = 5' in coercion to 'logical(1)'</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="joining" class="slide level2 smaller">
<h2>Joining</h2>
<ul>
<li>Linking 2 datasets together using the <code>join</code> family of functions is an integral part of data analysis</li>
<li>However, <code>join</code> functions are highly efficient functions and can be useful in a number of siutations, even when we don’t have 2 separate datasets</li>
<li><code>inner_join</code> links two dataframes together based on a column in common, with the number of rows equal to the number of rows in the ‘left’ table that have a matching row in the ‘right’ table</li>
</ul>
<div class="columns">
<div class="column" style="width:30%;">
<div class="cell" data-hash="slides_cache/revealjs/join-display_b1f1ca78e852a5c648e7b900d75fbe1c">
<div class="cell-output-display">
<table class="table" data-quarto-postprocess="true" style="font-size: 18px; margin-left: auto; margin-right: auto;">
<caption>df_1: Rows 1 - 3 out of 3</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">group</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">value1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">a</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">b</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">c</td>
<td style="text-align: right;">3</td>
</tr>
</tbody>
</table>


</div>
</div>
</div><div class="column" style="width:30%;">
<div class="cell" data-hash="slides_cache/revealjs/join-display-2_3cd0e335e1018796e33a3aa082284381">
<div class="cell-output-display">
<table class="table" data-quarto-postprocess="true" style="font-size: 18px; margin-left: auto; margin-right: auto;">
<caption>df_2: Rows 1 - 3 out of 3</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">group</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">value2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">b</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td style="text-align: left;">c</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">d</td>
<td style="text-align: right;">6</td>
</tr>
</tbody>
</table>


</div>
</div>
</div><div class="column" style="width:40%;">
<div class="cell" data-hash="slides_cache/revealjs/join-display-3_9450ce021707eefaa62379557ca4205b">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>joined <span class="ot">&lt;-</span> df_1 <span class="sc">|&gt;</span> <span class="fu">inner_join</span>(df_2, <span class="at">by=</span><span class="st">"group"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="slides_cache/revealjs/join-display-4_fdabf00e61248d6234256d99084afefc">
<div class="cell-output-display">
<table class="table" data-quarto-postprocess="true" style="font-size: 18px; margin-left: auto; margin-right: auto;">
<caption>joined: Rows 1 - 2 out of 2</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">group</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">value1</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">value2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">b</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td style="text-align: left;">c</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">5</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</div>
</section>
<section id="example-usage-inner-join-instead-of-ifelse" class="slide level2 smaller">
<h2>Example usage: inner join instead of <code>ifelse</code></h2>
<ul>
<li>Can think of <code>inner_join</code> as being able to both <code>filter</code> and <code>mutate</code> new columns</li>
<li>Example: apply different per-group scaling factor to 300,000 measurements from 3 groups</li>
<li>On one joining column <code>join</code> isn’t much quicker, but it’s far more legible and scales well to both having more groups in the joining column, and additional joining columns</li>
</ul>
<div class="columns">
<div class="column" style="width:30%;">
<div class="cell" data-hash="slides_cache/revealjs/join-display-5_f729535ee7a426942f83d2f6b51e5120">
<div class="cell-output-display">
<table class="table" data-quarto-postprocess="true" style="font-size: 15px; margin-left: auto; margin-right: auto;">
<caption>df: Rows 1 - 5 out of 300000</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">group</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">time</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">a</td>
<td style="text-align: left;">2020-03-05 00:00:00</td>
<td style="text-align: right;">0.5987276</td>
</tr>
<tr class="even">
<td style="text-align: left;">a</td>
<td style="text-align: left;">2020-03-05 00:01:00</td>
<td style="text-align: right;">-0.5292368</td>
</tr>
<tr class="odd">
<td style="text-align: left;">a</td>
<td style="text-align: left;">2020-03-05 00:02:00</td>
<td style="text-align: right;">0.6289489</td>
</tr>
<tr class="even">
<td style="text-align: left;">a</td>
<td style="text-align: left;">2020-03-05 00:03:00</td>
<td style="text-align: right;">-0.3701616</td>
</tr>
<tr class="odd">
<td style="text-align: left;">a</td>
<td style="text-align: left;">2020-03-05 00:04:00</td>
<td style="text-align: right;">1.7871348</td>
</tr>
</tbody>
</table>


</div>
</div>
</div><div class="column" style="width:30%;">
<div class="cell" data-hash="slides_cache/revealjs/join-scales-2_1b3678666cc420103c7d221d8152bfce">
<div class="cell-output-display">
<table class="table" data-quarto-postprocess="true" style="font-size: 15px; margin-left: auto; margin-right: auto;">
<caption>scales: Rows 1 - 3 out of 3</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">group</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">scale</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">a</td>
<td style="text-align: right;">2.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">b</td>
<td style="text-align: right;">7.8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">c</td>
<td style="text-align: right;">9.0</td>
</tr>
</tbody>
</table>


</div>
</div>
</div><div class="column" style="width:30%;">
<div class="cell" data-hash="slides_cache/revealjs/join-scales-4_8bbbac3b48d36c14a35ca4aa10b68738">
<div class="cell-output-display">
<table class="table" data-quarto-postprocess="true" style="font-size: 15px; margin-left: auto; margin-right: auto;">
<caption>joined: Rows 1 - 5 out of 300000</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">group</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">time</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">value</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">scale</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">a</td>
<td style="text-align: left;">2020-03-05 00:00:00</td>
<td style="text-align: right;">0.5987276</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">a</td>
<td style="text-align: left;">2020-03-05 00:01:00</td>
<td style="text-align: right;">-0.5292368</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">a</td>
<td style="text-align: left;">2020-03-05 00:02:00</td>
<td style="text-align: right;">0.6289489</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">a</td>
<td style="text-align: left;">2020-03-05 00:03:00</td>
<td style="text-align: right;">-0.3701616</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">a</td>
<td style="text-align: left;">2020-03-05 00:04:00</td>
<td style="text-align: right;">1.7871348</td>
<td style="text-align: right;">2</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</div>
<div class="fragment">
<div class="cell" data-hash="slides_cache/revealjs/join-scales-comp_b726334c55145b383ee6d37f107a5439">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>f_join <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb18-2"><a href="#cb18-2"></a>  df <span class="sc">|&gt;</span> <span class="fu">inner_join</span>(scales, <span class="at">by=</span><span class="st">"group"</span>)</span>
<span id="cb18-3"><a href="#cb18-3"></a>}</span>
<span id="cb18-4"><a href="#cb18-4"></a></span>
<span id="cb18-5"><a href="#cb18-5"></a>f_ifelse <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb18-6"><a href="#cb18-6"></a>  df <span class="sc">|&gt;</span></span>
<span id="cb18-7"><a href="#cb18-7"></a>    <span class="fu">mutate</span>(<span class="at">scale =</span> <span class="fu">ifelse</span>(group <span class="sc">==</span> <span class="st">'a'</span>, <span class="dv">2</span>,</span>
<span id="cb18-8"><a href="#cb18-8"></a>                          <span class="fu">ifelse</span>(group <span class="sc">==</span> <span class="st">'b'</span>, <span class="fl">7.8</span>,</span>
<span id="cb18-9"><a href="#cb18-9"></a>                                 <span class="fu">ifelse</span>(group <span class="sc">==</span> <span class="st">'c'</span>, <span class="dv">9</span>, <span class="cn">NA</span>))))</span>
<span id="cb18-10"><a href="#cb18-10"></a>  </span>
<span id="cb18-11"><a href="#cb18-11"></a>}</span>
<span id="cb18-12"><a href="#cb18-12"></a></span>
<span id="cb18-13"><a href="#cb18-13"></a>res <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="fu">f_join</span>(), <span class="fu">f_ifelse</span>(), <span class="at">times=</span><span class="dv">10</span>)</span>
<span id="cb18-14"><a href="#cb18-14"></a><span class="fu">summary</span>(res)[<span class="fu">c</span>(<span class="st">"expr"</span>, <span class="st">"median"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        expr   median
1   f_join() 18.82268
2 f_ifelse() 23.34759</code></pre>
</div>
</div>
</div>
</section>
<section id="left_join" class="slide level2">
<h2><code>left_join</code></h2>
<ul>
<li>A <code>left_join</code> returns <strong>all rows</strong> in the left table, but only those in the right that match the condition</li>
<li>Any column from the right table that didn’t have a match in the left table is filled with <code>NA</code></li>
</ul>
<div class="columns">
<div class="column" style="width:15%;">
<div class="cell" data-hash="slides_cache/revealjs/join-left-1_576b2fa35c75a307ec4d90e5c63578a7">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>df1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  group val1
1     a    1
2     b    2
3     c    3
4     d    4</code></pre>
</div>
</div>
</div><div class="column" style="width:15%;">
<div class="cell" data-hash="slides_cache/revealjs/join-left-2_d1630d039f3edab51b6940691bd2cabf">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>df2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  group val2
1     a    1
2     b    4
3     c    9</code></pre>
</div>
</div>
</div><div class="column" style="width:35%;">
<div class="cell" data-hash="slides_cache/revealjs/join-left-3_7349fd02b26b9e4967c12843338bc31b">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>df1 <span class="sc">|&gt;</span> </span>
<span id="cb24-2"><a href="#cb24-2"></a>  <span class="fu">left_join</span>(df2, <span class="at">by=</span><span class="st">"group"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  group val1 val2
1     a    1    1
2     b    2    4
3     c    3    9
4     d    4   NA</code></pre>
</div>
</div>
</div><div class="column" style="width:35%;">
<div class="cell" data-hash="slides_cache/revealjs/join-left-4_73931d226d7959c93443e16d2f549b27">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>df1 <span class="sc">|&gt;</span> </span>
<span id="cb26-2"><a href="#cb26-2"></a>  <span class="fu">inner_join</span>(df2, <span class="at">by=</span><span class="st">"group"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  group val1 val2
1     a    1    1
2     b    2    4
3     c    3    9</code></pre>
</div>
</div>
</div>
</div>
</section>
<section id="example-usage-filling-gaps-with-left_join" class="slide level2">
<h2>Example usage: filling gaps with <code>left_join</code></h2>
<ul>
<li>Very useful if want to be aware of missing values</li>
<li>Useful for filling gaps in non-uniformly sampled time-series so can count missingness or interpolate</li>
</ul>
<div class="columns">
<div class="column" style="width:30%;">
<div class="cell" data-hash="slides_cache/revealjs/join-left-6_d31e65671f47e742bae857bd6ac21b41">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        date measurement
1 2020-01-01  0.22433188
2 2020-01-03  0.24482316
3 2020-01-05 -0.08055568</code></pre>
</div>
</div>
</div><div class="column" style="width:20%;">
<div class="cell" data-hash="slides_cache/revealjs/join-left-8_b0bc63c92820cab3a3b0c86c98093eed">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>all_times</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        date
1 2020-01-01
2 2020-01-02
3 2020-01-03
4 2020-01-04
5 2020-01-05</code></pre>
</div>
</div>
</div><div class="column" style="width:50%;">
<div class="cell" data-hash="slides_cache/revealjs/join-left-9_4371eae0a32ca59150595332514540de">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a>all_times <span class="sc">|&gt;</span> <span class="fu">left_join</span>(df, <span class="at">by=</span><span class="st">"date"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        date measurement
1 2020-01-01  0.22433188
2 2020-01-02          NA
3 2020-01-03  0.24482316
4 2020-01-04          NA
5 2020-01-05 -0.08055568</code></pre>
</div>
</div>
</div>
</div>
</section>
<section id="interval-joins" class="slide level2 smaller">
<h2>Interval joins</h2>
<ul>
<li>Joins aren’t limited to joining on equal values, can also join on <strong>intervals</strong> or <strong>closest value</strong></li>
<li>Example: Have measurements from every day in 2020, but want to limit analysis to 5 specific weeks</li>
</ul>
<div class="columns">
<div class="column" style="width:20%;">
<div class="cell" data-hash="slides_cache/revealjs/join-intervals-2_d2db5c820260263fbd2181b2f836631d">
<div class="cell-output-display">
<table class="table" data-quarto-postprocess="true" style="font-size: 15px; margin-left: auto; margin-right: auto;">
<caption>df_interval: Rows 1 - 10 out of 366</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">time</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">measurement</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2020-01-01</td>
<td style="text-align: right;">-0.6576604</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-01-02</td>
<td style="text-align: right;">1.4838342</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020-01-03</td>
<td style="text-align: right;">1.3895139</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-01-04</td>
<td style="text-align: right;">-0.1295129</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020-01-05</td>
<td style="text-align: right;">1.0107976</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-01-06</td>
<td style="text-align: right;">-1.4932955</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020-01-07</td>
<td style="text-align: right;">-0.2289131</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-01-08</td>
<td style="text-align: right;">0.6771906</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020-01-09</td>
<td style="text-align: right;">1.0269499</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-01-10</td>
<td style="text-align: right;">-0.5570999</td>
</tr>
</tbody>
</table>


</div>
</div>
</div><div class="column" style="width:25%;">
<div class="cell" data-hash="slides_cache/revealjs/join-intervals-3_e226bde143ddbbb9eceb1ba2f99d6d1a">
<div class="cell-output-display">
<table class="table" data-quarto-postprocess="true" style="font-size: 15px; margin-left: auto; margin-right: auto;">
<caption>weeks: Rows 1 - 5 out of 5</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">week_group</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">week_start</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">week_end</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">a</td>
<td style="text-align: left;">2020-02-14</td>
<td style="text-align: left;">2020-02-21</td>
</tr>
<tr class="even">
<td style="text-align: left;">b</td>
<td style="text-align: left;">2020-03-17</td>
<td style="text-align: left;">2020-03-24</td>
</tr>
<tr class="odd">
<td style="text-align: left;">c</td>
<td style="text-align: left;">2020-05-08</td>
<td style="text-align: left;">2020-05-15</td>
</tr>
<tr class="even">
<td style="text-align: left;">d</td>
<td style="text-align: left;">2020-09-20</td>
<td style="text-align: left;">2020-09-27</td>
</tr>
<tr class="odd">
<td style="text-align: left;">e</td>
<td style="text-align: left;">2020-11-13</td>
<td style="text-align: left;">2020-11-20</td>
</tr>
</tbody>
</table>


</div>
</div>
</div><div class="column" style="width:50%;">
<div class="cell" data-hash="slides_cache/revealjs/join-intervals-4_f6380cad96ad8ff56f8278008108cb8d">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>joined <span class="ot">&lt;-</span> df_interval <span class="sc">|&gt;</span></span>
<span id="cb34-2"><a href="#cb34-2"></a>  <span class="fu">inner_join</span>(weeks, </span>
<span id="cb34-3"><a href="#cb34-3"></a>             <span class="at">by=</span><span class="fu">join_by</span>(time <span class="sc">&gt;=</span> week_start, time <span class="sc">&lt;</span> week_end))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="slides_cache/revealjs/join-intervals-5_8b4fc879acca9daa7165341c3214306a">
<div class="cell-output-display">
<table class="table" data-quarto-postprocess="true" style="font-size: 15px; margin-left: auto; margin-right: auto;">
<caption>joined: Rows 1 - 10 out of 35</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">time</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">measurement</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">week_group</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">week_start</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">week_end</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2020-02-14</td>
<td style="text-align: right;">-0.5619612</td>
<td style="text-align: left;">a</td>
<td style="text-align: left;">2020-02-14</td>
<td style="text-align: left;">2020-02-21</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-02-15</td>
<td style="text-align: right;">-0.2133952</td>
<td style="text-align: left;">a</td>
<td style="text-align: left;">2020-02-14</td>
<td style="text-align: left;">2020-02-21</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020-02-16</td>
<td style="text-align: right;">1.7400116</td>
<td style="text-align: left;">a</td>
<td style="text-align: left;">2020-02-14</td>
<td style="text-align: left;">2020-02-21</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-02-17</td>
<td style="text-align: right;">-1.0639221</td>
<td style="text-align: left;">a</td>
<td style="text-align: left;">2020-02-14</td>
<td style="text-align: left;">2020-02-21</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020-02-18</td>
<td style="text-align: right;">-1.9508774</td>
<td style="text-align: left;">a</td>
<td style="text-align: left;">2020-02-14</td>
<td style="text-align: left;">2020-02-21</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-02-19</td>
<td style="text-align: right;">1.2910768</td>
<td style="text-align: left;">a</td>
<td style="text-align: left;">2020-02-14</td>
<td style="text-align: left;">2020-02-21</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020-02-20</td>
<td style="text-align: right;">-0.5042165</td>
<td style="text-align: left;">a</td>
<td style="text-align: left;">2020-02-14</td>
<td style="text-align: left;">2020-02-21</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-03-17</td>
<td style="text-align: right;">1.3886904</td>
<td style="text-align: left;">b</td>
<td style="text-align: left;">2020-03-17</td>
<td style="text-align: left;">2020-03-24</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020-03-18</td>
<td style="text-align: right;">0.3820922</td>
<td style="text-align: left;">b</td>
<td style="text-align: left;">2020-03-17</td>
<td style="text-align: left;">2020-03-24</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020-03-19</td>
<td style="text-align: right;">0.6009245</td>
<td style="text-align: left;">b</td>
<td style="text-align: left;">2020-03-17</td>
<td style="text-align: left;">2020-03-24</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</div>
</section>
<section id="benchmark" class="slide level2 smaller">
<h2>Benchmark</h2>
<ul>
<li>On only 366 rows with 5 groups it is 10x as fast, will scale better, and is more understandable</li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/join-intervals-6_284cb8aef8e5dfafbb98a9251909858f">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>f_intervaljoin <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb35-2"><a href="#cb35-2"></a>  df_interval <span class="sc">|&gt;</span></span>
<span id="cb35-3"><a href="#cb35-3"></a>    <span class="fu">inner_join</span>(weeks, <span class="at">by=</span><span class="fu">join_by</span>(time <span class="sc">&gt;=</span> week_start, time <span class="sc">&lt;</span> week_end))</span>
<span id="cb35-4"><a href="#cb35-4"></a>}</span>
<span id="cb35-5"><a href="#cb35-5"></a></span>
<span id="cb35-6"><a href="#cb35-6"></a>f_ifelse <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb35-7"><a href="#cb35-7"></a>  df_interval <span class="sc">|&gt;</span></span>
<span id="cb35-8"><a href="#cb35-8"></a>    <span class="fu">mutate</span>(<span class="at">week_group =</span> <span class="fu">ifelse</span>(time <span class="sc">&gt;=</span> <span class="fu">as_date</span>(<span class="st">"2020-02-14"</span>) <span class="sc">&amp;</span> time <span class="sc">&lt;</span> <span class="fu">as_date</span>(<span class="st">"2020-02-21"</span>),</span>
<span id="cb35-9"><a href="#cb35-9"></a>                               <span class="st">'a'</span>,</span>
<span id="cb35-10"><a href="#cb35-10"></a>                               <span class="fu">ifelse</span>(time <span class="sc">&gt;=</span> <span class="fu">as_date</span>(<span class="st">"2020-03-17"</span>) <span class="sc">&amp;</span> time <span class="sc">&lt;</span> <span class="fu">as_date</span>(<span class="st">"2020-03-24"</span>),</span>
<span id="cb35-11"><a href="#cb35-11"></a>                                      <span class="st">'b'</span>,</span>
<span id="cb35-12"><a href="#cb35-12"></a>                                      <span class="fu">ifelse</span>(time <span class="sc">&gt;=</span> <span class="fu">as_date</span>(<span class="st">"2020-05-08"</span>) <span class="sc">&amp;</span> time <span class="sc">&lt;</span> <span class="fu">as_date</span>(<span class="st">"2020-05-15"</span>),</span>
<span id="cb35-13"><a href="#cb35-13"></a>                                             <span class="st">'c'</span>,</span>
<span id="cb35-14"><a href="#cb35-14"></a>                                             <span class="fu">ifelse</span>(time <span class="sc">&gt;=</span> <span class="fu">as_date</span>(<span class="st">"2020-09-20"</span>) <span class="sc">&amp;</span> time <span class="sc">&lt;</span> <span class="fu">as_date</span>(<span class="st">"2020-09-27"</span>),</span>
<span id="cb35-15"><a href="#cb35-15"></a>                                                    <span class="st">'d'</span>,</span>
<span id="cb35-16"><a href="#cb35-16"></a>                                                    <span class="fu">ifelse</span>(time <span class="sc">&gt;=</span> <span class="fu">as_date</span>(<span class="st">"2020-11-13"</span>) <span class="sc">&amp;</span> time <span class="sc">&lt;</span> <span class="fu">as_date</span>(<span class="st">"2020-11-20"</span>),</span>
<span id="cb35-17"><a href="#cb35-17"></a>                                                           <span class="st">'e'</span>, </span>
<span id="cb35-18"><a href="#cb35-18"></a>                                                           <span class="cn">NA</span>)))))) <span class="sc">|&gt;</span></span>
<span id="cb35-19"><a href="#cb35-19"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(week_group))</span>
<span id="cb35-20"><a href="#cb35-20"></a>}</span>
<span id="cb35-21"><a href="#cb35-21"></a></span>
<span id="cb35-22"><a href="#cb35-22"></a>res <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="fu">f_intervaljoin</span>(), <span class="fu">f_ifelse</span>(), <span class="at">times=</span><span class="dv">10</span>)</span>
<span id="cb35-23"><a href="#cb35-23"></a><span class="fu">summary</span>(res)[<span class="fu">c</span>(<span class="st">"expr"</span>, <span class="st">"median"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              expr    median
1 f_intervaljoin()  1.645427
2       f_ifelse() 20.924986</code></pre>
</div>
</div>
</section></section>
<section>
<section id="different-backends" class="title-slide slide level1 center">
<h1>Different backends</h1>

</section>
<section id="example-dataset" class="slide level2 smaller">
<h2>Example dataset</h2>
<ul>
<li>What if we’re using fast functions but still experiencing slow performance due to dataset’s <em>size</em>?</li>
<li>Example dataset: Company House data containing 5 million rows (<a href="http://download.companieshouse.gov.uk/en_output.html">440MB archive download</a>, extracts to 2.4GB) of all companies incorporated in the UK since 1856</li>
<li>Using first million rows as an example</li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/company-house-1_726d7113ca9289eda84278dd3efe5538">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"BasicCompanyDataAsOneFile-2023-05-01.csv"</span>, <span class="at">n_max=</span><span class="fl">1e6</span>, <span class="at">show_col_types=</span><span class="cn">FALSE</span>)</span>
<span id="cb37-2"><a href="#cb37-2"></a>df<span class="sc">$</span>IncorporationDate <span class="ot">&lt;-</span> <span class="fu">as_date</span>(df<span class="sc">$</span>IncorporationDate, <span class="at">format=</span><span class="st">"%d/%m/%Y"</span>)</span>
<span id="cb37-3"><a href="#cb37-3"></a><span class="fu">dim</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1000000      55</code></pre>
</div>
</div>
<div class="cell" data-hash="slides_cache/revealjs/company-house-2_44dc0a1dc8a81cc1c445b396ab3b3850">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a>df <span class="sc">|&gt;</span> </span>
<span id="cb39-2"><a href="#cb39-2"></a>  <span class="fu">select</span>(CompanyName, RegAddress.PostTown, IncorporationDate, SICCode.SicText_1) <span class="sc">|&gt;</span></span>
<span id="cb39-3"><a href="#cb39-3"></a>  <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  CompanyName            RegAddress.PostTown IncorporationDate SICCode.SicText_1
  &lt;chr&gt;                  &lt;chr&gt;               &lt;date&gt;            &lt;chr&gt;            
1 ! HEAL UR TECH LTD     GUILDFORD           2022-10-12        33140 - Repair o…
2 ! LTD                  LEEDS               2012-09-11        99999 - Dormant …
3 !? LTD                 ROMILEY             2018-06-05        47710 - Retail s…
4 !BIG IMPACT GRAPHICS … LONDON              2018-12-28        18129 - Printing…
5 !GOBERUB LTD           BISHOP'S STORTFORD  2021-05-17        62020 - Informat…
6 !NFOGENIE LTD          LONDON              2021-07-21        58290 - Other so…</code></pre>
</div>
</div>
</section>
<section id="question-1-how-many-companies-have-the-same-name" class="slide level2">
<h2>Question 1: How many companies have the same name?</h2>
<ul>
<li>Will use several basic research questions to have some ‘real-world’ analysis code to benchmark</li>
<li>How many companies have the same name?</li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/company-house-3_83cd453d50a787ecb886bc1f11d42891">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a>df <span class="sc">|&gt;</span> </span>
<span id="cb41-2"><a href="#cb41-2"></a>  <span class="fu">count</span>(CompanyName) <span class="sc">|&gt;</span> </span>
<span id="cb41-3"><a href="#cb41-3"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb41-4"><a href="#cb41-4"></a>  <span class="fu">nrow</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 773</code></pre>
</div>
</div>
</section>
<section id="question-2-what-york-postcode-has-the-most-businesses" class="slide level2">
<h2>Question 2: What York postcode has the most businesses?</h2>
<ul>
<li>Want to find the 5 postcodes with most businesses being created in York</li>
<li>Need to do some string manipulation to extract the first part of the <code>YOXX YYY</code> postcode format</li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/company-house-4_a3833e6257aedf3e6ce9d585299f4212">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a>df <span class="sc">|&gt;</span> </span>
<span id="cb43-2"><a href="#cb43-2"></a>  <span class="fu">filter</span>(RegAddress.PostTown <span class="sc">==</span> <span class="st">'YORK'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb43-3"><a href="#cb43-3"></a>  <span class="fu">mutate</span>(<span class="at">postcode =</span> <span class="fu">word</span>(RegAddress.PostCode, <span class="dv">1</span>, <span class="at">sep=</span><span class="st">" "</span>)) <span class="sc">|&gt;</span></span>
<span id="cb43-4"><a href="#cb43-4"></a>  <span class="fu">count</span>(postcode) <span class="sc">|&gt;</span></span>
<span id="cb43-5"><a href="#cb43-5"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">|&gt;</span></span>
<span id="cb43-6"><a href="#cb43-6"></a>  <span class="fu">head</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
  postcode     n
  &lt;chr&gt;    &lt;int&gt;
1 YO30       486
2 YO19       325
3 YO26       271
4 YO1        241
5 YO31       179</code></pre>
</div>
</div>
</section>
<section id="question-3-classifications" class="slide level2 smaller">
<h2>Question 3: Classifications</h2>
<ul>
<li>Companies can be assigned with up to 4 classifications from a list of 1,042 options</li>
<li>Do classifications tend to cluster together? I.e. is the average number of classifications a company has related to the first classification?</li>
<li>Slightly tenuous example but wanted to demonstrate pivoting + joining!</li>
<li>Only want to look at classifications that are used by at least 10 companies (<code>inner_join</code> to filter)</li>
<li>Multiple classifications are stored in 4 <strong>wide columns</strong> that are NA when unused - easier to count the number of non-null column entries in <strong>long</strong> format</li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/company-house-5_46001da6ec1d31873a7c4da0ce2b6485">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  CompanyName              SICCode.SicText_1 SICCode.SicText_2 SICCode.SicText_3
  &lt;chr&gt;                    &lt;chr&gt;             &lt;chr&gt;             &lt;chr&gt;            
1 ! HEAL UR TECH LTD       33140 - Repair o… 47421 - Retail s… &lt;NA&gt;             
2 ! LTD                    99999 - Dormant … &lt;NA&gt;              &lt;NA&gt;             
3 !? LTD                   47710 - Retail s… &lt;NA&gt;              &lt;NA&gt;             
4 !BIG IMPACT GRAPHICS LI… 18129 - Printing… 59112 - Video pr… 63120 - Web port…
5 !GOBERUB LTD             62020 - Informat… 70229 - Manageme… 79110 - Travel a…
6 !NFOGENIE LTD            58290 - Other so… &lt;NA&gt;              &lt;NA&gt;             
# ℹ 1 more variable: SICCode.SicText_4 &lt;chr&gt;</code></pre>
</div>
</div>
</section>
<section id="question-3-classifications-code" class="slide level2 smaller">
<h2>Question 3: Classifications (code)</h2>
<div class="cell" data-hash="slides_cache/revealjs/company-house-8_dc73b0140510c75762b46cd9ae39cb79">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a><span class="co"># 755 rows containing the SIC codes that at least 10 companies have</span></span>
<span id="cb46-2"><a href="#cb46-2"></a><span class="co"># Only 1 column, SICCode.SicText_1</span></span>
<span id="cb46-3"><a href="#cb46-3"></a>sic_10_companies <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> </span>
<span id="cb46-4"><a href="#cb46-4"></a>                <span class="fu">count</span>(SICCode.SicText_1) <span class="sc">|&gt;</span></span>
<span id="cb46-5"><a href="#cb46-5"></a>                <span class="fu">filter</span>(n <span class="sc">&gt;=</span> <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb46-6"><a href="#cb46-6"></a>                <span class="fu">select</span>(SICCode.SicText_1)</span>
<span id="cb46-7"><a href="#cb46-7"></a></span>
<span id="cb46-8"><a href="#cb46-8"></a>df <span class="sc">|&gt;</span></span>
<span id="cb46-9"><a href="#cb46-9"></a>  <span class="co"># Could do a filter to restrict to these 10 companies, but it's actually quicker to use an inner join</span></span>
<span id="cb46-10"><a href="#cb46-10"></a>  <span class="fu">inner_join</span>(sic_10_companies, <span class="at">by=</span><span class="st">"SICCode.SicText_1"</span>) <span class="sc">|&gt;</span></span>
<span id="cb46-11"><a href="#cb46-11"></a>  <span class="fu">select</span>(CompanyNumber, SICCode.SicText_1, SICCode.SicText_2, SICCode.SicText_3, SICCode.SicText_4) <span class="sc">|&gt;</span> </span>
<span id="cb46-12"><a href="#cb46-12"></a>  <span class="fu">mutate</span>(<span class="at">first_classification =</span> SICCode.SicText_1) <span class="sc">|&gt;</span></span>
<span id="cb46-13"><a href="#cb46-13"></a>  <span class="co"># Pivoting to make it easier to count how many non-NULL classifications each company has</span></span>
<span id="cb46-14"><a href="#cb46-14"></a>  <span class="fu">pivot_longer</span>(<span class="fu">c</span>(SICCode.SicText_1, SICCode.SicText_2, SICCode.SicText_3, SICCode.SicText_4)) <span class="sc">|&gt;</span></span>
<span id="cb46-15"><a href="#cb46-15"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value)) <span class="sc">|&gt;</span></span>
<span id="cb46-16"><a href="#cb46-16"></a>  <span class="co"># Count how many classifications each company has</span></span>
<span id="cb46-17"><a href="#cb46-17"></a>  <span class="fu">count</span>(CompanyNumber, first_classification) <span class="sc">|&gt;</span></span>
<span id="cb46-18"><a href="#cb46-18"></a>  <span class="co"># Calculate the average number per the first classification</span></span>
<span id="cb46-19"><a href="#cb46-19"></a>  <span class="fu">group_by</span>(first_classification) <span class="sc">|&gt;</span></span>
<span id="cb46-20"><a href="#cb46-20"></a>  <span class="fu">summarise</span>(<span class="at">mean_classifications =</span> <span class="fu">mean</span>(n, <span class="at">na.rm=</span>T)) <span class="sc">|&gt;</span></span>
<span id="cb46-21"><a href="#cb46-21"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(mean_classifications)) <span class="sc">|&gt;</span></span>
<span id="cb46-22"><a href="#cb46-22"></a>  <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  first_classification                                      mean_classifications
  &lt;chr&gt;                                                                    &lt;dbl&gt;
1 7210 - Hardware consultancy                                               3   
2 07100 - Mining of iron ores                                               2.48
3 10611 - Grain milling                                                     2.43
4 18110 - Printing of newspapers                                            2.43
5 14131 - Manufacture of other men's outerwear                              2.40
6 01280 - Growing of spices, aromatic, drug and pharmaceut…                 2.39</code></pre>
</div>
</div>
</section></section>
<section>
<section id="data.table" class="title-slide slide level1 center">
<h1>data.table</h1>

</section>
<section id="introduction-1" class="slide level2 smaller">
<h2>Introduction</h2>
<ul>
<li><code>data.table</code> is an alternative to data.frame/tibble that is optimised for speed and low memory usage</li>
<li>The trade-off is that its API is a bit/lot less user friendly</li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/data-table-1_21aa6c81b64dc6ee6b782e6d28405ced">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb48-2"><a href="#cb48-2"></a>dt <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"BasicCompanyDataAsOneFile-2023-05-01.csv"</span>, <span class="at">nrows=</span><span class="fl">1e6</span>)         <span class="co"># fread is the equivalent of read.csv</span></span>
<span id="cb48-3"><a href="#cb48-3"></a>dt[, IncorporationDate <span class="sc">:</span><span class="er">=</span> <span class="fu">as_date</span>(IncorporationDate, <span class="at">format=</span><span class="st">"%d/%m/%Y"</span>) ]  <span class="co"># Creates a new column by *reference*</span></span>
<span id="cb48-4"><a href="#cb48-4"></a><span class="fu">dim</span>(dt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1000000      55</code></pre>
</div>
</div>
<div class="cell" data-hash="slides_cache/revealjs/data-table-2_1dccb9a90a6c53bb666082c4ef9e1af1">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a><span class="co"># Display rows 1-5 and the specified columns</span></span>
<span id="cb50-2"><a href="#cb50-2"></a>dt[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, .(CompanyName, RegAddress.PostTown, IncorporationDate, SICCode.SicText_1)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                    CompanyName RegAddress.PostTown IncorporationDate
1:           ! HEAL UR TECH LTD           GUILDFORD        2022-10-12
2:                        ! LTD               LEEDS        2012-09-11
3:                       !? LTD             ROMILEY        2018-06-05
4: !BIG IMPACT GRAPHICS LIMITED              LONDON        2018-12-28
5:                 !GOBERUB LTD  BISHOP'S STORTFORD        2021-05-17
                                       SICCode.SicText_1
1:                33140 - Repair of electrical equipment
2:                               99999 - Dormant Company
3: 47710 - Retail sale of clothing in specialised stores
4:                               18129 - Printing n.e.c.
5: 62020 - Information technology consultancy activities</code></pre>
</div>
</div>
</section>
<section id="counting-number-of-companies-with-the-same-name" class="slide level2">
<h2>Counting number of companies with the same name</h2>
<ul>
<li>Generally, <code>dt[i, j, k]</code> means for data table <code>dt</code>, filter on rows <code>i</code>, create and/or select columns <code>j</code>, and group by <code>k</code></li>
<li><code>data.table</code> operations don’t use the Pipe (<code>|&gt;</code> or <code>%&gt;%</code>), so can either chain together <code>[]</code> or create intermediate variables</li>
<li><code>data.table</code> have <code>data.frame</code> as a class so can use standard functions on them, just won’t benefit from the speed up</li>
<li><code>.N</code> is the equivalent of <code>count</code></li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/data-table-3_5eb15b839c060ce5afe26be6c9b55237">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a><span class="fu">nrow</span>( dt[ , .N, <span class="at">by=</span>.(CompanyName) ][ N <span class="sc">&gt;</span> <span class="dv">1</span> ] )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 773</code></pre>
</div>
</div>
</section>
<section id="york-postcodes-with-most-business" class="slide level2">
<h2>York Postcodes with most business</h2>
<ul>
<li>In this example it’s easier to create an intermediate variable than use a one-liner</li>
<li><code>.SD</code> applies an operation to a subset of columns (all by default)</li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/data-table-4_9b9b22146b9abe7c732d3a4fd1c5c6bb">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a>postcodes <span class="ot">&lt;-</span> dt[ RegAddress.PostTown <span class="sc">==</span> <span class="st">'YORK'</span>, .(<span class="at">postcode =</span> <span class="fu">word</span>(RegAddress.PostCode, <span class="dv">1</span>))][, .N, by<span class="ot">=</span>postcode]</span>
<span id="cb54-2"><a href="#cb54-2"></a>postcodes[<span class="fu">order</span>(<span class="sc">-</span>postcodes<span class="sc">$</span>N), <span class="fu">head</span>(.SD, <span class="dv">5</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   postcode   N
1:     YO30 486
2:     YO19 325
3:     YO26 271
4:      YO1 241
5:     YO31 179</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a><span class="co"># Alternative one-liner</span></span>
<span id="cb56-2"><a href="#cb56-2"></a><span class="co">#setorder(dt[ RegAddress.PostTown == 'YORK', .(postcode = word(RegAddress.PostCode, 1))][, .N, by=postcode], -N)[, head(.SD, 5)]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="number-of-classifications" class="slide level2 smaller">
<h2>Number of classifications</h2>
<ul>
<li>Joins are less intuitive. <code>x[y]</code> is equal to <code>left_join(y, x)</code>, <strong>NOT</strong> <code>inner_join(x, y)</code></li>
<li><code>melt</code> is equivalent to <code>pivot_longer</code> and IMO less intuitive</li>
<li>Intermdiate variables everywhere!</li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/data-table-5_66d7c810d2e5f5932207d67f9a7763a3">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a>sic_10_companies_dt <span class="ot">&lt;-</span> dt[, .N, by<span class="ot">=</span>.(SICCode.SicText_1)][ N <span class="sc">&gt;=</span> <span class="dv">10</span>, .(SICCode.SicText_1) ]</span>
<span id="cb57-2"><a href="#cb57-2"></a>dt_companies_wide <span class="ot">&lt;-</span> dt[ sic_10_companies_dt,  <span class="co"># This is a join!</span></span>
<span id="cb57-3"><a href="#cb57-3"></a>                         .(CompanyNumber, </span>
<span id="cb57-4"><a href="#cb57-4"></a>                           <span class="at">first_classification =</span> SICCode.SicText_1,</span>
<span id="cb57-5"><a href="#cb57-5"></a>                           SICCode.SicText_1,</span>
<span id="cb57-6"><a href="#cb57-6"></a>                           SICCode.SicText_2,</span>
<span id="cb57-7"><a href="#cb57-7"></a>                           SICCode.SicText_3,</span>
<span id="cb57-8"><a href="#cb57-8"></a>                           SICCode.SicText_4),</span>
<span id="cb57-9"><a href="#cb57-9"></a>                          on<span class="ot">=</span>.(SICCode.SicText_1)]</span>
<span id="cb57-10"><a href="#cb57-10"></a>dt_companies_long <span class="ot">&lt;-</span> <span class="fu">melt</span>(dt_companies_wide, <span class="at">id.vars=</span><span class="fu">c</span>(<span class="st">'CompanyNumber'</span>, <span class="st">'first_classification'</span>))</span>
<span id="cb57-11"><a href="#cb57-11"></a>dt_companies_mean <span class="ot">&lt;-</span> dt_companies_long[ value <span class="sc">!=</span> <span class="st">''</span>,  <span class="co"># Removes the unused SIC columns</span></span>
<span id="cb57-12"><a href="#cb57-12"></a>                                        .N, </span>
<span id="cb57-13"><a href="#cb57-13"></a>                                        by<span class="ot">=</span>.(CompanyNumber, first_classification)][, </span>
<span id="cb57-14"><a href="#cb57-14"></a>                                                                                   .(<span class="at">mean_classifications =</span> <span class="fu">mean</span>(N, <span class="at">na.rm=</span>T)), </span>
<span id="cb57-15"><a href="#cb57-15"></a>                                                                                   by<span class="ot">=</span>.(first_classification)]</span>
<span id="cb57-16"><a href="#cb57-16"></a><span class="fu">head</span>(dt_companies_mean[ <span class="fu">order</span>(mean_classifications, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                 first_classification
1:                                        7210 - Hardware consultancy
2:                                        07100 - Mining of iron ores
3:                                     18110 - Printing of newspapers
4:                                              10611 - Grain milling
5:                       14131 - Manufacture of other men's outerwear
6: 01280 - Growing of spices, aromatic, drug and pharmaceutical crops
   mean_classifications
1:             3.000000
2:             2.478261
3:             2.428571
4:             2.428571
5:             2.401606
6:             2.392157</code></pre>
</div>
</div>
</section>
<section id="speed-comparison-with-tidyverse" class="slide level2">
<h2>Speed comparison with tidyverse</h2>

<img data-src="slides_files/figure-revealjs/data-table-comparison-results-1.png" width="960" class="r-stretch"></section></section>
<section>
<section id="tidytable-and-dtplyr" class="title-slide slide level1 center">
<h1><code>tidytable</code> and <code>dtplyr</code></h1>

</section>
<section id="tidytable-introduction" class="slide level2 smaller">
<h2><code>tidytable</code>: introduction</h2>
<div class="columns">
<div class="column" style="width:40%;">
<ul>
<li><code>tidytable</code> is a drop-in replacement for common tidyverse functions that under the hood work on a <code>data.table</code> object</li>
<li>So (in theory!) you get the speed of <code>data.table</code> but the user friendly API of the <code>tidyverse</code></li>
<li>Just load the library then all subsequent calls to <code>mutate</code>, <code>inner_join</code>, <code>count</code>, <code>select</code>, <code>filter</code> etc… will use the <code>tidytable</code> versions that work on a <code>data.table</code></li>
<li><strong>Beware</strong>: not all functions have been ported over and it explicitly overwrites the <code>dplyr</code>, <code>tidyr</code>, <code>purrr</code> functions</li>
<li>There’s a lag between changes to <code>tidyverse</code> being reflected in <code>tidytable</code></li>
</ul>
</div><div class="column" style="width:60%;">
<div class="sourceCode" id="cb59"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1"></a><span class="fu">library</span>(tidytable)</span>
<span id="cb59-2"><a href="#cb59-2"></a><span class="co"># Here we explicitly create tidytable from a regular data.frame</span></span>
<span id="cb59-3"><a href="#cb59-3"></a><span class="co"># But passing a regular data.frame or data.table into any tidytable function</span></span>
<span id="cb59-4"><a href="#cb59-4"></a><span class="co"># will implicitly change it to be a tidytable object</span></span>
<span id="cb59-5"><a href="#cb59-5"></a>dtt <span class="ot">&lt;-</span> <span class="fu">as_tidytable</span>(df)</span>
<span id="cb59-6"><a href="#cb59-6"></a></span>
<span id="cb59-7"><a href="#cb59-7"></a>dtt <span class="sc">|&gt;</span> </span>
<span id="cb59-8"><a href="#cb59-8"></a>    <span class="fu">count</span>(SICCode.SicText_1) <span class="sc">|&gt;</span></span>
<span id="cb59-9"><a href="#cb59-9"></a>    <span class="fu">filter</span>(n <span class="sc">&gt;=</span> <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb59-10"><a href="#cb59-10"></a>    <span class="fu">select</span>(SICCode.SicText_1) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell" data-hash="slides_cache/revealjs/unnamed-chunk-1_7bb53bafc5911ba8217ab1fa28b173a7">
<div class="cell-output cell-output-stdout">
<pre><code># A tidytable: 755 × 1
   SICCode.SicText_1                                                       
   &lt;chr&gt;                                                                   
 1 01110 - Growing of cereals (except rice), leguminous crops and oil seeds
 2 01120 - Growing of rice                                                 
 3 01130 - Growing of vegetables and melons, roots and tubers              
 4 01160 - Growing of fibre crops                                          
 5 01190 - Growing of other non-perennial crops                            
 6 01210 - Growing of grapes                                               
 7 01220 - Growing of tropical and subtropical fruits                      
 8 01240 - Growing of pome fruits and stone fruits                         
 9 01250 - Growing of other tree and bush fruits and nuts                  
10 01270 - Growing of beverage crops                                       
# ℹ 745 more rows</code></pre>
</div>
</div>
</div>
</div>
</section>
<section id="dtplyr-introduction" class="slide level2 smaller">
<h2><code>dtplyr</code>: introduction</h2>
<div class="columns">
<div class="column" style="width:40%;">
<ul>
<li>An alternative <code>data.table</code> wrapper is <code>dtplyr</code> (developed by RStudio team)</li>
<li>Works differently to <code>tidytable</code>: it sequentially builds up the equivalent <code>data.table</code> query, but only executes the code when you <strong>explicitly</strong> request it (using <code>collect()</code> or <code>as.data.frame/table()</code>)</li>
<li>Loading the package <strong>doesn’t</strong> affect your environment</li>
<li>Has less coverage than <code>tidytable</code></li>
</ul>
</div><div class="column" style="width:60%;">
<div class="cell" data-hash="slides_cache/revealjs/dtplyr-1_0ca5683774109b69085f552219ca65ed">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1"></a><span class="fu">library</span>(dtplyr)</span>
<span id="cb61-2"><a href="#cb61-2"></a></span>
<span id="cb61-3"><a href="#cb61-3"></a><span class="co"># dtplyr operates on `lazy data.tables` which are only created by this function</span></span>
<span id="cb61-4"><a href="#cb61-4"></a>dtp <span class="ot">&lt;-</span> <span class="fu">lazy_dt</span>(df)</span>
<span id="cb61-5"><a href="#cb61-5"></a></span>
<span id="cb61-6"><a href="#cb61-6"></a>dtp <span class="sc">|&gt;</span> </span>
<span id="cb61-7"><a href="#cb61-7"></a>    <span class="fu">count</span>(SICCode.SicText_1) <span class="sc">|&gt;</span></span>
<span id="cb61-8"><a href="#cb61-8"></a>    <span class="fu">filter</span>(n <span class="sc">&gt;=</span> <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb61-9"><a href="#cb61-9"></a>    <span class="fu">select</span>(SICCode.SicText_1) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Source: local data table [755 x 1]
Call:   `_DT1`[, .(n = .N), keyby = .(SICCode.SicText_1)][n &gt;= 10, .(SICCode.SicText_1)]

  SICCode.SicText_1                                                       
  &lt;chr&gt;                                                                   
1 01110 - Growing of cereals (except rice), leguminous crops and oil seeds
2 01120 - Growing of rice                                                 
3 01130 - Growing of vegetables and melons, roots and tubers              
4 01160 - Growing of fibre crops                                          
5 01190 - Growing of other non-perennial crops                            
6 01210 - Growing of grapes                                               
# ℹ 749 more rows

# Use as.data.table()/as.data.frame()/as_tibble() to access results</code></pre>
</div>
</div>
</div>
</div>
</section>
<section id="dtplyr-usage" class="slide level2 smaller">
<h2><code>dtplyr</code>: usage</h2>
<div class="columns">
<div class="column" style="width:45%;">
<ul>
<li>Can view the generated <code>data.table</code> query (subtly different to the one I manually wrote)</li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/dtplyr-2_7b4b188a6bf8edac57309d005102966d">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1"></a>dtp <span class="sc">|&gt;</span> </span>
<span id="cb63-2"><a href="#cb63-2"></a>    <span class="fu">count</span>(SICCode.SicText_1) <span class="sc">|&gt;</span></span>
<span id="cb63-3"><a href="#cb63-3"></a>    <span class="fu">filter</span>(n <span class="sc">&gt;=</span> <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb63-4"><a href="#cb63-4"></a>    <span class="fu">select</span>(SICCode.SicText_1) <span class="sc">|&gt;</span></span>
<span id="cb63-5"><a href="#cb63-5"></a>    <span class="fu">show_query</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>`_DT1`[, .(n = .N), keyby = .(SICCode.SicText_1)][n &gt;= 10, .(SICCode.SicText_1)]</code></pre>
</div>
</div>
</div><div class="column" style="width:45%;">
<ul>
<li>Run <code>collect()</code> to execute it and return a <code>tibble</code></li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/dtplyr-3_5c63101be893ce574b51f19f765973e7">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1"></a>dtp <span class="sc">|&gt;</span> </span>
<span id="cb65-2"><a href="#cb65-2"></a>    <span class="fu">count</span>(SICCode.SicText_1) <span class="sc">|&gt;</span></span>
<span id="cb65-3"><a href="#cb65-3"></a>    <span class="fu">filter</span>(n <span class="sc">&gt;=</span> <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb65-4"><a href="#cb65-4"></a>    <span class="fu">select</span>(SICCode.SicText_1) <span class="sc">|&gt;</span></span>
<span id="cb65-5"><a href="#cb65-5"></a>    <span class="fu">collect</span>() <span class="sc">|&gt;</span> </span>
<span id="cb65-6"><a href="#cb65-6"></a>    <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 1
  SICCode.SicText_1                                                       
  &lt;chr&gt;                                                                   
1 01110 - Growing of cereals (except rice), leguminous crops and oil seeds
2 01120 - Growing of rice                                                 
3 01130 - Growing of vegetables and melons, roots and tubers              
4 01160 - Growing of fibre crops                                          
5 01190 - Growing of other non-perennial crops                            
6 01210 - Growing of grapes                                               </code></pre>
</div>
</div>
</div>
</div>
</section>
<section id="dtplyr-chaining-queries" class="slide level2 smaller">
<h2><code>dtplyr</code>: chaining queries</h2>
<ul>
<li><code>dtplyr</code> queries that haven’t been <code>collect()</code> can be used in joins</li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/dtplyr-4_5bc1714a7abb02d6fe20fc91204e4979">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1"></a><span class="co"># NB: this returns a datatable QUERY, not a dataset itself</span></span>
<span id="cb67-2"><a href="#cb67-2"></a>sic_10_companies_dtp <span class="ot">&lt;-</span> dtp <span class="sc">|&gt;</span> </span>
<span id="cb67-3"><a href="#cb67-3"></a>    <span class="fu">count</span>(SICCode.SicText_1) <span class="sc">|&gt;</span></span>
<span id="cb67-4"><a href="#cb67-4"></a>    <span class="fu">filter</span>(n <span class="sc">&gt;=</span> <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb67-5"><a href="#cb67-5"></a>    <span class="fu">select</span>(SICCode.SicText_1) </span>
<span id="cb67-6"><a href="#cb67-6"></a></span>
<span id="cb67-7"><a href="#cb67-7"></a><span class="co"># Can join that query into the middle of another query to return another query</span></span>
<span id="cb67-8"><a href="#cb67-8"></a>results_dtp <span class="ot">&lt;-</span> dtp <span class="sc">|&gt;</span></span>
<span id="cb67-9"><a href="#cb67-9"></a>  <span class="fu">inner_join</span>(sic_10_companies_dtp, <span class="at">by=</span><span class="st">"SICCode.SicText_1"</span>) <span class="sc">|&gt;</span></span>
<span id="cb67-10"><a href="#cb67-10"></a>  <span class="fu">select</span>(CompanyNumber, SICCode.SicText_1, SICCode.SicText_2, SICCode.SicText_3, SICCode.SicText_4) <span class="sc">|&gt;</span> </span>
<span id="cb67-11"><a href="#cb67-11"></a>  <span class="fu">mutate</span>(<span class="at">first_classification =</span> SICCode.SicText_1) <span class="sc">|&gt;</span></span>
<span id="cb67-12"><a href="#cb67-12"></a>  <span class="fu">pivot_longer</span>(<span class="fu">c</span>(SICCode.SicText_1, SICCode.SicText_2, SICCode.SicText_3, SICCode.SicText_4)) <span class="sc">|&gt;</span></span>
<span id="cb67-13"><a href="#cb67-13"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value)) <span class="sc">|&gt;</span></span>
<span id="cb67-14"><a href="#cb67-14"></a>  <span class="fu">count</span>(CompanyNumber, first_classification) <span class="sc">|&gt;</span></span>
<span id="cb67-15"><a href="#cb67-15"></a>  <span class="fu">group_by</span>(first_classification) <span class="sc">|&gt;</span></span>
<span id="cb67-16"><a href="#cb67-16"></a>  <span class="fu">summarise</span>(<span class="at">mean_classifications =</span> <span class="fu">mean</span>(n, <span class="at">na.rm=</span>T)) <span class="sc">|&gt;</span></span>
<span id="cb67-17"><a href="#cb67-17"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(mean_classifications))</span>
<span id="cb67-18"><a href="#cb67-18"></a></span>
<span id="cb67-19"><a href="#cb67-19"></a><span class="co"># Finally execute the full query</span></span>
<span id="cb67-20"><a href="#cb67-20"></a>results_dtp <span class="sc">|&gt;</span></span>
<span id="cb67-21"><a href="#cb67-21"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb67-22"><a href="#cb67-22"></a>  <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  first_classification                                      mean_classifications
  &lt;chr&gt;                                                                    &lt;dbl&gt;
1 7210 - Hardware consultancy                                               3   
2 07100 - Mining of iron ores                                               2.48
3 10611 - Grain milling                                                     2.43
4 18110 - Printing of newspapers                                            2.43
5 14131 - Manufacture of other men's outerwear                              2.40
6 01280 - Growing of spices, aromatic, drug and pharmaceut…                 2.39</code></pre>
</div>
</div>
</section>
<section id="benchmark-1" class="slide level2">
<h2>Benchmark</h2>

<img data-src="slides_files/figure-revealjs/data-table-all-plot-1.png" width="960" class="r-stretch"></section></section>
<section>
<section id="embedded-databases" class="title-slide slide level1 center">
<h1>Embedded databases</h1>

</section>
<section id="introduction-2" class="slide level2 smaller">
<h2>Introduction</h2>
<ul>
<li>All these options require reading the full dataset into memory, not viable if we have <strong>larger than memory data</strong></li>
<li>Embedded relational databases are stored on disk and only reading into memory as needed</li>
</ul>
<div class="fragment">
<ul>
<li>Will look at 2 variants:
<ul>
<li><code>SQLite</code></li>
<li><code>duckdb</code></li>
</ul></li>
<li>They use SQL (Structured Query Language, its own programming language) to interact with the data, but fortunately in R we can use our <code>tidyverse</code> functions just like <code>dtplyr</code> rather than learn a new language</li>
</ul>
</div>
</section>
<section id="interfacing-with-sqlite-in-r" class="slide level2">
<h2>Interfacing with SQLite in R</h2>
<ul>
<li>Connect to the DB using <code>dbConnect()</code> from <code>library(DBI)</code></li>
<li>DBs are organised into tables (can think of a table as a CSV file)</li>
<li><code>dbWriteTable()</code> will write a dataframe to the DB</li>
</ul>
<div class="sourceCode" id="cb69"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1"></a><span class="fu">library</span>(DBI)  <span class="co"># General database library</span></span>
<span id="cb69-2"><a href="#cb69-2"></a><span class="fu">library</span>(RSQLite)</span>
<span id="cb69-3"><a href="#cb69-3"></a><span class="co"># If data.sql doesn't exist, it will be created</span></span>
<span id="cb69-4"><a href="#cb69-4"></a>con_sql <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(<span class="fu">SQLite</span>(), <span class="st">"data.sql"</span>)</span>
<span id="cb69-5"><a href="#cb69-5"></a><span class="fu">dbWriteTable</span>(con_sql, <span class="st">"data_1e6"</span>, df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="sqlite-usage" class="slide level2 smaller">
<h2>SQLite usage</h2>
<div class="columns">
<div class="column" style="width:50%;">
<ul>
<li>Can view SQL query with <em>identical</em> code to <code>dtplyr</code>, except the source is from <code>tbl</code></li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/sqlite-2_592ee34047454122b784270881ebb619">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1"></a><span class="fu">tbl</span>(con_sql, <span class="st">"data_1e6"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb70-2"><a href="#cb70-2"></a>  <span class="fu">filter</span>(RegAddress.PostTown <span class="sc">==</span> <span class="st">'YORK'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb70-3"><a href="#cb70-3"></a>  <span class="fu">mutate</span>(<span class="at">postcode =</span> <span class="fu">word</span>(RegAddress.PostCode, <span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb70-4"><a href="#cb70-4"></a>  <span class="fu">count</span>(postcode) <span class="sc">|&gt;</span></span>
<span id="cb70-5"><a href="#cb70-5"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">|&gt;</span></span>
<span id="cb70-6"><a href="#cb70-6"></a>  <span class="fu">head</span>(<span class="dv">50</span>) <span class="sc">|&gt;</span></span>
<span id="cb70-7"><a href="#cb70-7"></a>  <span class="fu">show_query</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;SQL&gt;
SELECT `postcode`, COUNT(*) AS `n`
FROM (
  SELECT *, word(`RegAddress.PostCode`, 1.0) AS `postcode`
  FROM `data_1e6`
  WHERE (`RegAddress.PostTown` = 'YORK')
)
GROUP BY `postcode`
ORDER BY `n` DESC
LIMIT 50</code></pre>
</div>
</div>
</div><div class="column" style="width:50%;">
<ul>
<li><strong>Errors</strong> because the developers haven’t translated <code>word</code> into SQL yet, so it is translated directly but <code>word</code> isn’t a function in SQL</li>
<li>Solution: use <code>substr</code> from <code>base</code> which has been translated but doesn’t do exactly the same</li>
<li>This is more likely to happen the more specific and uncommon a function is</li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/sqlite-3_e9b98dd8a951f5bcefb85b6ae7fbc6ad">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1"></a><span class="fu">tbl</span>(con_sql, <span class="st">"data_1e6"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb72-2"><a href="#cb72-2"></a>  <span class="fu">filter</span>(RegAddress.PostTown <span class="sc">==</span> <span class="st">'YORK'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb72-3"><a href="#cb72-3"></a>  <span class="fu">mutate</span>(<span class="at">postcode =</span> <span class="fu">substr</span>(RegAddress.PostCode, <span class="dv">1</span>, <span class="dv">4</span>)) <span class="sc">|&gt;</span></span>
<span id="cb72-4"><a href="#cb72-4"></a>  <span class="fu">count</span>(postcode) <span class="sc">|&gt;</span></span>
<span id="cb72-5"><a href="#cb72-5"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">|&gt;</span></span>
<span id="cb72-6"><a href="#cb72-6"></a>  <span class="fu">head</span>(<span class="dv">50</span>) <span class="sc">|&gt;</span></span>
<span id="cb72-7"><a href="#cb72-7"></a>  <span class="fu">collect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 23 × 2
   postcode     n
   &lt;chr&gt;    &lt;int&gt;
 1 "YO30"     486
 2 "YO19"     325
 3 "YO26"     271
 4 "YO1 "     241
 5 "YO31"     180
 6 "YO24"     178
 7 "YO10"     172
 8 "YO32"     169
 9 "YO23"     161
10 "YO42"     142
# ℹ 13 more rows</code></pre>
</div>
</div>
</div>
</div>
</section>
<section id="duckdb-introduction" class="slide level2">
<h2><code>duckdb</code>: introduction</h2>
<ul>
<li>Designed for <strong>fast analytics</strong> (column-oriented) whereas SQLite is designed for <strong>transactions</strong> (row-oriented)</li>
<li>Very new, first demo was 2020 (SQLite first release was 2000)</li>
<li>Can read directly from CSV or has its database files like SQLite</li>
<li>Use the same <code>dbConnect()</code> function but passing in a different driver</li>
</ul>
<div class="sourceCode" id="cb74"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1"></a><span class="fu">library</span>(duckdb)</span>
<span id="cb74-2"><a href="#cb74-2"></a>con_dd <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(<span class="fu">duckdb</span>(), <span class="st">"data.duckdb"</span>)</span>
<span id="cb74-3"><a href="#cb74-3"></a><span class="fu">dbWriteTable</span>(con_dd, <span class="st">"data_1e6"</span>, df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="duckdb-usage" class="slide level2 smaller">
<h2><code>duckdb</code>: usage</h2>
<div class="columns">
<div class="column" style="width:50%;">
<ul>
<li>Duckdb uses the same SQL language, albeit with subtle differences in available functions</li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/duckdb-2_39c697a4e146d7f94574fdd7180e750f">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1"></a><span class="fu">tbl</span>(con_dd, <span class="st">"data_1e6"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb75-2"><a href="#cb75-2"></a>  <span class="fu">filter</span>(RegAddress.PostTown <span class="sc">==</span> <span class="st">'YORK'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb75-3"><a href="#cb75-3"></a>  <span class="fu">mutate</span>(<span class="at">postcode =</span> <span class="fu">substr</span>(RegAddress.PostCode, <span class="dv">1</span>, <span class="dv">4</span>)) <span class="sc">|&gt;</span></span>
<span id="cb75-4"><a href="#cb75-4"></a>  <span class="fu">count</span>(postcode) <span class="sc">|&gt;</span></span>
<span id="cb75-5"><a href="#cb75-5"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">|&gt;</span></span>
<span id="cb75-6"><a href="#cb75-6"></a>  <span class="fu">head</span>(<span class="dv">50</span>) <span class="sc">|&gt;</span></span>
<span id="cb75-7"><a href="#cb75-7"></a>  <span class="fu">show_query</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;SQL&gt;
SELECT postcode, COUNT(*) AS n
FROM (
  SELECT *, SUBSTR("RegAddress.PostCode", 1, 4) AS postcode
  FROM data_1e6
  WHERE ("RegAddress.PostTown" = 'YORK')
) q01
GROUP BY postcode
ORDER BY n DESC
LIMIT 50</code></pre>
</div>
</div>
</div><div class="column" style="width:50%;">
<ul>
<li><code>word</code> is also not ported to duckdb so again use the <code>substr</code> version</li>
<li>Code is again identical to both <code>SQLite</code> and <code>dtplyr</code></li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/duckdb-3_1ba81f2a4e1746b5e0494c2e263cd3ff">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1"></a><span class="fu">tbl</span>(con_dd, <span class="st">"data_1e6"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb77-2"><a href="#cb77-2"></a>  <span class="fu">filter</span>(RegAddress.PostTown <span class="sc">==</span> <span class="st">'YORK'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb77-3"><a href="#cb77-3"></a>  <span class="fu">mutate</span>(<span class="at">postcode =</span> <span class="fu">substr</span>(RegAddress.PostCode, <span class="dv">1</span>, <span class="dv">4</span>)) <span class="sc">|&gt;</span></span>
<span id="cb77-4"><a href="#cb77-4"></a>  <span class="fu">count</span>(postcode) <span class="sc">|&gt;</span></span>
<span id="cb77-5"><a href="#cb77-5"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">|&gt;</span></span>
<span id="cb77-6"><a href="#cb77-6"></a>  <span class="fu">head</span>(<span class="dv">50</span>) <span class="sc">|&gt;</span></span>
<span id="cb77-7"><a href="#cb77-7"></a>  <span class="fu">collect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 23 × 2
   postcode     n
   &lt;chr&gt;    &lt;dbl&gt;
 1 "YO30"     486
 2 "YO19"     325
 3 "YO26"     271
 4 "YO1 "     241
 5 "YO31"     180
 6 "YO24"     178
 7 "YO10"     172
 8 "YO32"     169
 9 "YO23"     161
10 "YO42"     142
# ℹ 13 more rows</code></pre>
</div>
</div>
</div>
</div>
</section>
<section id="overall-benchmark" class="slide level2 smaller">
<h2>Overall benchmark</h2>
<div class="columns">
<div class="column" style="width:60%;">
<div class="cell" data-hash="slides_cache/revealjs/db-comparison-4_3ebac547fe941f54c16fff8ae0946482">
<div class="cell-output-display">
<p><img data-src="slides_files/figure-revealjs/db-comparison-4-1.png" width="960"></p>
</div>
</div>
</div><div class="column" style="width:40%;">
<ul>
<li><code>data.table</code> is the fastest! But it requires learning a new ‘language’</li>
<li>All of the other options are still much faster than <code>tidyverse</code> and still let you use same code</li>
<li><code>tidytable</code> is my personal sweetspot between ease of use and performance gains</li>
<li><code>duckdb</code> and <code>sqlite</code> are also useful when data storage is a concern:
<ul>
<li>CSV: 2.4GB</li>
<li>SQLite: 1.9GB</li>
<li>Duckdb: 500MB</li>
</ul></li>
</ul>
</div>
</div>
</section>
<section id="benchmark---all-5-million-rows" class="slide level2">
<h2>Benchmark - all 5 million rows</h2>

<img data-src="slides_files/figure-revealjs/benchmark-5million-1.png" width="960" class="r-stretch"></section></section>
<section>
<section id="rcpp" class="title-slide slide level1 center">
<h1>Rcpp</h1>

</section>
<section id="introduction-3" class="slide level2 smaller">
<h2>Introduction</h2>
<ul>
<li>Sometimes for loops are necessary:
<ul>
<li>No inbuilt vectorised solution</li>
<li>Recurrent algorithm such as stepping through time or space</li>
<li>Performant critical code and need more specialised data structures</li>
</ul></li>
<li><code>Rcpp</code>, which combines R and C++, to the rescue!</li>
</ul>
<div class="fragment">
<ul>
<li>C++ is <strong>compiled</strong> which makes it very fast, but it also requires more effort to both write programs in it and interface with R:</li>
<li><code>Rcpp</code> makes this process easy by providing:
<ul>
<li>A C++ library that contains similar data structures and functions to R</li>
<li>An R package that compiles C++ code and makes them easily accessible within R</li>
</ul></li>
</ul>
</div>
</section>
<section id="basic-example" class="slide level2 smaller">
<h2>Basic example</h2>
<ul>
<li>Can use <code>Rcpp::cppFunction()</code> to write a C++ function as a string or <code>Rcpp::sourceCpp()</code> if it’s in a separate file</li>
<li>Both methods do the same:
<ul>
<li>Compile C++ code</li>
<li>Create an R function that calls it</li>
</ul></li>
<li>C++ has many differences with R, having to assign every variable a type is most notable</li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/rcpp-1_f802530e1546104a8720b9ff90266895">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1"></a><span class="fu">library</span>(Rcpp)</span>
<span id="cb79-2"><a href="#cb79-2"></a><span class="fu">cppFunction</span>(<span class="st">"double sumRcpp(NumericVector x) {</span></span>
<span id="cb79-3"><a href="#cb79-3"></a><span class="st">  int n = x.size();  // R objects have their own type (NumericVector) with useful attributes</span></span>
<span id="cb79-4"><a href="#cb79-4"></a><span class="st">  double total = 0;  // Need to instantiate variables before use</span></span>
<span id="cb79-5"><a href="#cb79-5"></a><span class="st">  for (int i = 0; i &lt; n; i++) {  // C++ indexes start at 0</span></span>
<span id="cb79-6"><a href="#cb79-6"></a><span class="st">    total += x[i];</span></span>
<span id="cb79-7"><a href="#cb79-7"></a><span class="st">  }</span></span>
<span id="cb79-8"><a href="#cb79-8"></a><span class="st">  return total;</span></span>
<span id="cb79-9"><a href="#cb79-9"></a><span class="st">}"</span>)</span>
<span id="cb79-10"><a href="#cb79-10"></a><span class="co"># The sumRcpp function is instantly available within R</span></span>
<span id="cb79-11"><a href="#cb79-11"></a><span class="fu">sumRcpp</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6</code></pre>
</div>
</div>
</section>
<section id="syntatic-sugar---data-structures" class="slide level2 smaller">
<h2>Syntatic sugar - data structures</h2>
<ul>
<li>When calling an Rcpp function, the inputs are automatically converted from their R type into the specified C++ type</li>
<li><code>NumericVector</code> is a special Rcpp data structure that represents a vector of floats, so will accept both <code>c(1.2, 2.4, 3.6)</code>, and <code>c(1, 2, 3)</code>, but not <code>c('a', 'b', 'c')</code></li>
<li><code>IntegerVector</code> coerces floats into integers</li>
<li><code>CharacterVector</code> also exists for strings, and <code>NumericMatrix</code> for 2D structures</li>
<li>For scalar values can use standard C++ data types <code>int</code>, <code>double</code>, <code>char</code> etc…</li>
<li>Can also use any other C++ data structure</li>
<li><code>wrap()</code> is an Rcpp function that converts back from C++ to R, useful when returning at the end of a function!</li>
</ul>
</section>
<section id="syntatic-sugar---functions" class="slide level2">
<h2>Syntatic sugar - functions</h2>
<ul>
<li>There’s no penalty to using for loops in C++ so they are very common</li>
<li>But to save typing boiler plate code, Rcpp provides ‘syntatical sugar’ functions that operate on the R-specific data types</li>
<li>Examples: <code>mean</code>, <code>log</code>, <code>exp</code>, <code>sin</code>, <code>any</code>, <code>all</code></li>
<li>The for loop wasn’t necessary!</li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/rcpp-4_09b2cdcdda7fc8eb27a59fdb7afd9faf">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1"></a><span class="fu">cppFunction</span>(<span class="st">"double sumRcppsugar(NumericVector x) {</span></span>
<span id="cb81-2"><a href="#cb81-2"></a><span class="st">  return sum(x);</span></span>
<span id="cb81-3"><a href="#cb81-3"></a><span class="st">}"</span>)</span>
<span id="cb81-4"><a href="#cb81-4"></a><span class="fu">sumRcppsugar</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6</code></pre>
</div>
</div>
</section>
<section id="sum-benchmarks" class="slide level2">
<h2><code>sum</code> benchmarks</h2>
<div class="columns">
<div class="column" style="width:40%;">
<div class="cell" data-hash="slides_cache/revealjs/unnamed-chunk-4_febd498d0934611e4a8fc162356a0529">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1"></a>sumR <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb83-2"><a href="#cb83-2"></a>  total <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb83-3"><a href="#cb83-3"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(<span class="fu">length</span>(x))) {</span>
<span id="cb83-4"><a href="#cb83-4"></a>    total <span class="ot">&lt;-</span> total <span class="sc">+</span> x[i]</span>
<span id="cb83-5"><a href="#cb83-5"></a>  }</span>
<span id="cb83-6"><a href="#cb83-6"></a>  total</span>
<span id="cb83-7"><a href="#cb83-7"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>The Rcpp implementations are around 30x faster than the R version</li>
<li>The syntatic sugar version is the same speed as the for loop</li>
<li>The inbuilt <code>sum</code> is highly optimised</li>
</ul>
</div><div class="column" style="width:60%;">
<div class="cell" data-hash="slides_cache/revealjs/unnamed-chunk-5_6efdad2912da0e3d801d1e6b84e42ee7">
<div class="cell-output-display">
<p><img data-src="slides_files/figure-revealjs/unnamed-chunk-5-1.png" width="960"></p>
</div>
</div>
</div>
</div>
</section>
<section id="real-world-example-kalman-filter" class="slide level2 smaller">
<h2>Real world example: Kalman Filter</h2>
<div class="columns">
<div class="column" style="width:50%;">
<div class="cell" data-hash="slides_cache/revealjs/rcpp-6_878d3dc4dfafe424c7b112167adee61f">
<div class="sourceCode cell-code" id="cb84" data-code-line-numbers="8-15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1"></a>kf_r <span class="ot">&lt;-</span> <span class="cf">function</span>(y, m, <span class="at">Q=</span><span class="fl">0.5</span>, <span class="at">H=</span><span class="fl">0.5</span>) {</span>
<span id="cb84-2"><a href="#cb84-2"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb84-3"><a href="#cb84-3"></a>  alpha <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(n<span class="sc">+</span><span class="dv">1</span>, m))</span>
<span id="cb84-4"><a href="#cb84-4"></a>  P <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(m, m, n<span class="sc">+</span><span class="dv">1</span>))</span>
<span id="cb84-5"><a href="#cb84-5"></a>  alpha[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># Initialise with zero mean and high variance</span></span>
<span id="cb84-6"><a href="#cb84-6"></a>  P[, , <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fl">1e3</span></span>
<span id="cb84-7"><a href="#cb84-7"></a>  Z <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">1</span>, <span class="at">dim=</span><span class="fu">c</span>(n, m)) </span>
<span id="cb84-8"><a href="#cb84-8"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb84-9"><a href="#cb84-9"></a>    P_updated <span class="ot">&lt;-</span> P[, , i] <span class="sc">+</span> Q</span>
<span id="cb84-10"><a href="#cb84-10"></a>    <span class="co"># Calculate kalman gain</span></span>
<span id="cb84-11"><a href="#cb84-11"></a>    K <span class="ot">&lt;-</span> P_updated <span class="sc">%*%</span> <span class="fu">t</span>(Z[i, ]) <span class="sc">%*%</span> <span class="fu">solve</span>(Z[i, ] <span class="sc">%*%</span> P_updated <span class="sc">%*%</span> <span class="fu">t</span>(Z[i, ]) <span class="sc">+</span> H)</span>
<span id="cb84-12"><a href="#cb84-12"></a>    <span class="co"># Update state and covariance</span></span>
<span id="cb84-13"><a href="#cb84-13"></a>    alpha[i<span class="sc">+</span><span class="dv">1</span>, ] <span class="ot">&lt;-</span> alpha[i, ] <span class="sc">+</span> K <span class="sc">%*%</span> (y[i] <span class="sc">-</span> Z[i, ] <span class="sc">%*%</span> alpha[i, ])</span>
<span id="cb84-14"><a href="#cb84-14"></a>    P[, , i<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> (<span class="fu">diag</span>(m) <span class="sc">-</span> K <span class="sc">%*%</span> Z[i, ]) <span class="sc">%*%</span> P_updated</span>
<span id="cb84-15"><a href="#cb84-15"></a>  }</span>
<span id="cb84-16"><a href="#cb84-16"></a>  <span class="fu">list</span>(<span class="at">alpha=</span>alpha, <span class="at">P=</span>P)</span>
<span id="cb84-17"><a href="#cb84-17"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div><div class="column" style="width:50%;">
<ul>
<li>The Kalman Filter is an algorithm that estimates unobserved parameters in a noisy system</li>
<li>It is recursive, the estimate at time <span class="math inline">\(t\)</span> solely depends on the value at time <span class="math inline">\(t-1\)</span>, hence is a good candidate for Rcpp</li>
<li>R implementation is straight forward series of matrix operations</li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/rcpp-7_b18594f9655b4ba17c4b3f09159b2080">
<div class="cell-output-display">
<p><img data-src="slides_files/figure-revealjs/rcpp-7-1.png" width="960"></p>
</div>
</div>
</div>
</div>
</section>
<section id="kalman-filter---rcpp-implementation" class="slide level2 smaller">
<h2>Kalman Filter - Rcpp implementation</h2>
<div class="columns">
<div class="column" style="width:60%;">
<div class="cell" data-hash="slides_cache/revealjs/rcpp-8_9139958184505af802d5131ad47a9b83">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1"></a><span class="fu">cppFunction</span>(<span class="st">"NumericVector kf_rcpp(arma::vec y, int m, float Q=0.5, float H=0.5) {</span></span>
<span id="cb85-2"><a href="#cb85-2"></a><span class="st">  int n = y.n_rows;</span></span>
<span id="cb85-3"><a href="#cb85-3"></a><span class="st">  </span></span>
<span id="cb85-4"><a href="#cb85-4"></a><span class="st">  arma::mat alpha(n+1, m, arma::fill::none);</span></span>
<span id="cb85-5"><a href="#cb85-5"></a><span class="st">  arma::cube P(m, m, n+1, arma::fill::none);</span></span>
<span id="cb85-6"><a href="#cb85-6"></a><span class="st">  arma::mat Z(n, m, arma::fill::ones);</span></span>
<span id="cb85-7"><a href="#cb85-7"></a><span class="st">  </span></span>
<span id="cb85-8"><a href="#cb85-8"></a><span class="st">  // Initialise</span></span>
<span id="cb85-9"><a href="#cb85-9"></a><span class="st">  alpha.row(0).fill(0);</span></span>
<span id="cb85-10"><a href="#cb85-10"></a><span class="st">  P.slice(0).diag().fill(1000);</span></span>
<span id="cb85-11"><a href="#cb85-11"></a><span class="st">  </span></span>
<span id="cb85-12"><a href="#cb85-12"></a><span class="st">  // Run filter</span></span>
<span id="cb85-13"><a href="#cb85-13"></a><span class="st">  arma::mat P_updated(m, m);</span></span>
<span id="cb85-14"><a href="#cb85-14"></a><span class="st">  arma::mat K(m, m);</span></span>
<span id="cb85-15"><a href="#cb85-15"></a><span class="st">  for (int i=0; i&lt;n; i++) {</span></span>
<span id="cb85-16"><a href="#cb85-16"></a><span class="st">    P_updated = P.slice(i) + Q;</span></span>
<span id="cb85-17"><a href="#cb85-17"></a><span class="st">    // Calculate kalman gain:</span></span>
<span id="cb85-18"><a href="#cb85-18"></a><span class="st">    K = P_updated * Z.row(i).t() * arma::inv(Z.row(i) * P_updated * Z.row(i).t() + H);</span></span>
<span id="cb85-19"><a href="#cb85-19"></a><span class="st">    // Update state and covariance</span></span>
<span id="cb85-20"><a href="#cb85-20"></a><span class="st">    alpha.row(i+1) = alpha.row(i) + K * (y[i] - Z.row(i) * alpha.row(i));</span></span>
<span id="cb85-21"><a href="#cb85-21"></a><span class="st">    P.slice(i+1) = (arma::eye(m, m) - K * Z.row(i)) * P_updated;</span></span>
<span id="cb85-22"><a href="#cb85-22"></a><span class="st">  }</span></span>
<span id="cb85-23"><a href="#cb85-23"></a><span class="st">  </span></span>
<span id="cb85-24"><a href="#cb85-24"></a><span class="st">  return wrap(alpha);  // This is crucial, converts the Armadillo matrix into an R NumericVector</span></span>
<span id="cb85-25"><a href="#cb85-25"></a><span class="st">}"</span>, <span class="at">depends=</span><span class="st">"RcppArmadillo"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div><div class="column" style="width:40%;">
<ul>
<li>Rcpp implementation is very similar, only using the <code>RcppArmadillo</code> library for access to 3D arrays</li>
<li>Can then call <code>kf_r()</code> or <code>kf_rcpp()</code> identically</li>
</ul>
</div>
</div>
</section>
<section id="benchmark-2" class="slide level2">
<h2>Benchmark</h2>
<ul>
<li>~80x quicker in Rcpp!</li>
<li>Been able to go from hourly to minutely time-resolution</li>
<li>Core library function so worth investing the development time</li>
</ul>

<img data-src="slides_files/figure-revealjs/rcpp-9-1.png" width="960" class="r-stretch"></section>
<section id="parallelisation-viking" class="slide level2 smaller">
<h2>Parallelisation / Viking</h2>
<ul>
<li>For iterative jobs that don’t fit within tabular data can run <strong>parallelised</strong> for loops
<ul>
<li>Fitting models</li>
<li>Network downloads/uploads</li>
<li>File processing</li>
</ul></li>
<li>For ‘small’ jobs can run locally using <code>parallel::mclapply</code> (Linux), <code>doParallel</code> and <code>foreach</code> (Windows), or <code>furrr</code> (all OS, Tidyverse, combines <code>future</code> and <code>purrr</code>)</li>
</ul>
<div class="fragment">
<ul>
<li>For larger jobs (both duration of each iteration and number of iterations), <strong>Viking</strong> is very useful with <a href="https://wiki.york.ac.uk/display/RCS/VK4%29+Job+script+configuration#VK4)Jobscriptconfiguration-Arrayjobs">array jobs</a></li>
<li>Viking also useful to free up PC when running a computationally intensive library (e.g.&nbsp;Stan, INLA, Keras). Optimising these is application-specific</li>
</ul>
</div>
<div class="fragment">
<ul>
<li><code>future.batchtools</code> offers the ability to remove the boilerplate of creating Slurm job scripts for array jobs and allow you to easily switch between running sequentially, local multi-core parallelisation, and independent processes Slurm array jobs. <strong>UNTESTED</strong></li>
</ul>
</div>
</section>
<section id="resources" class="slide level2 smaller">
<h2>Resources</h2>
<ul>
<li>Vectorisation: <a href="https://adv-r.hadley.nz/perf-improve.html#vectorise">Chapter in Advanced R</a></li>
<li>Joining: <a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">Tidyverse docs</a>, <a href="https://joins.spathon.com/">interactive visual join viewer</a> (nb: ‘outer’ joins are called ‘full’ joins in R)</li>
<li><code>data.table</code>: <a href="https://cran.r-project.org/web/packages/data.table/vignettes/datatable-intro.html">vignette</a>, <a href="https://wetlandscapes.com/blog/a-comparison-of-r-dialects/#joining-data-full-join">syntax comparison with tidyverse</a></li>
<li><code>tidytable</code> vs <code>dtplyr</code>: <a href="https://markfairbanks.github.io/tidytable/articles/speed_comparisons.html">benchmarking</a> between <code>tidytable</code>, <code>data.table</code>, <code>dtplyr</code>, and <code>tidyverse</code> and <code>pandas</code> (nb: from <code>tidytable</code> author)</li>
<li>SQLite: <a href="https://www.sqlitetutorial.net/">tutorial</a></li>
<li><code>duckdb</code>: <a href="https://duckdb.org/docs/api/r">official docs</a></li>
<li><code>Rcpp</code>: <a href="https://adv-r.hadley.nz/rcpp.html">chapter in Advanced R</a>, <a href="https://link.springer.com/book/10.1007/978-1-4614-6868-4">Rcpp book</a> (thorough), <a href="https://teuder.github.io/rcpp4everyone_en/">Rcpp for everyone book</a> (accessible)</li>
<li>Parallelisation: <a href="https://bookdown.org/rdpeng/rprogdatascience/parallel-computation.html#building-a-socket-cluster">chapter in R Programming for Data Science ebook</a></li>
<li>Viking: <a href="https://wiki.york.ac.uk/display/RCS/Viking+-+University+of+York+Research+Computing+Cluster">wiki</a></li>
</ul>
</section></section>
<section>
<section id="misc" class="title-slide slide level1 center">
<h1>Misc</h1>

</section>
<section id="worked-example---regex" class="slide level2" data-visibility="uncounted">
<h2>Worked example - regex</h2>
<ul>
<li>The <code>basename</code> and <code>dirname</code> solution was faster than <code>regex</code></li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/unnamed-chunk-6_6ee900d66e0092eb6621f262e5facc69">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1"></a>example_4 <span class="ot">&lt;-</span> <span class="cf">function</span>(paths) {</span>
<span id="cb86-2"><a href="#cb86-2"></a>  <span class="fu">gsub</span>(<span class="st">".+</span><span class="sc">\\</span><span class="st">/+([[:alnum:]]+)</span><span class="sc">\\</span><span class="st">/([[:alnum:]]+</span><span class="sc">\\</span><span class="st">.[[:alnum:]]+)$"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1_</span><span class="sc">\\</span><span class="st">2"</span>, paths)</span>
<span id="cb86-3"><a href="#cb86-3"></a>}</span>
<span id="cb86-4"><a href="#cb86-4"></a><span class="fu">example_4</span>(<span class="fu">c</span>(<span class="st">"foo/bar/car/001.txt"</span>, <span class="st">"har/far/lar/002.txt"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "car_001.txt" "lar_002.txt"</code></pre>
</div>
</div>
<div class="cell" data-hash="slides_cache/revealjs/unnamed-chunk-7_bf0eb13b7a3fd1757992872237a8ebfb">
<div class="cell-output cell-output-stdout">
<pre><code>                         expr    median
1 example_1_vectorised(paths) 6650.4320
2    sapply(paths, example_1) 6630.4525
3            example_2(paths) 1180.3090
4            example_3(paths)  116.3725
5            example_4(paths)  366.1625</code></pre>
</div>
</div>
</section>
<section id="case-when" class="slide level2" data-visibility="uncounted">
<h2>Case when</h2>
<ul>
<li>No speed difference between <code>ifelse</code> and <code>case_when</code></li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/unnamed-chunk-8_a34a24a198757127fabc1b3e2d5a7bf0">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1"></a>f_casewhen <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb89-2"><a href="#cb89-2"></a>  df_interval <span class="sc">|&gt;</span></span>
<span id="cb89-3"><a href="#cb89-3"></a>    <span class="fu">mutate</span>(<span class="at">week_group =</span> <span class="fu">case_when</span>(</span>
<span id="cb89-4"><a href="#cb89-4"></a>      time <span class="sc">&gt;=</span> <span class="fu">as_date</span>(<span class="st">"2020-02-14"</span>) <span class="sc">&amp;</span> time <span class="sc">&lt;</span> <span class="fu">as_date</span>(<span class="st">"2020-02-21"</span>) <span class="sc">~</span> <span class="st">'a'</span>,</span>
<span id="cb89-5"><a href="#cb89-5"></a>      time <span class="sc">&gt;=</span> <span class="fu">as_date</span>(<span class="st">"2020-03-17"</span>) <span class="sc">&amp;</span> time <span class="sc">&lt;</span> <span class="fu">as_date</span>(<span class="st">"2020-03-24"</span>) <span class="sc">~</span> <span class="st">'b'</span>,</span>
<span id="cb89-6"><a href="#cb89-6"></a>      time <span class="sc">&gt;=</span> <span class="fu">as_date</span>(<span class="st">"2020-05-08"</span>) <span class="sc">&amp;</span> time <span class="sc">&lt;</span> <span class="fu">as_date</span>(<span class="st">"2020-05-15"</span>) <span class="sc">~</span> <span class="st">'c'</span>,</span>
<span id="cb89-7"><a href="#cb89-7"></a>      time <span class="sc">&gt;=</span> <span class="fu">as_date</span>(<span class="st">"2020-09-20"</span>) <span class="sc">&amp;</span> time <span class="sc">&lt;</span> <span class="fu">as_date</span>(<span class="st">"2020-09-27"</span>) <span class="sc">~</span> <span class="st">'d'</span>,</span>
<span id="cb89-8"><a href="#cb89-8"></a>      time <span class="sc">&gt;=</span> <span class="fu">as_date</span>(<span class="st">"2020-11-13"</span>) <span class="sc">&amp;</span> time <span class="sc">&lt;</span> <span class="fu">as_date</span>(<span class="st">"2020-11-20"</span>) <span class="sc">~</span> <span class="st">'e'</span>,</span>
<span id="cb89-9"><a href="#cb89-9"></a>      <span class="at">.default =</span> <span class="cn">NA_character_</span></span>
<span id="cb89-10"><a href="#cb89-10"></a>    )) <span class="sc">|&gt;</span></span>
<span id="cb89-11"><a href="#cb89-11"></a>      <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(week_group))</span>
<span id="cb89-12"><a href="#cb89-12"></a>}</span>
<span id="cb89-13"><a href="#cb89-13"></a></span>
<span id="cb89-14"><a href="#cb89-14"></a>res <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(<span class="fu">f_intervaljoin</span>(), <span class="fu">f_ifelse</span>(), <span class="fu">f_casewhen</span>(), <span class="at">times=</span><span class="dv">10</span>)</span>
<span id="cb89-15"><a href="#cb89-15"></a><span class="fu">summary</span>(res)[<span class="fu">c</span>(<span class="st">"expr"</span>, <span class="st">"median"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              expr    median
1 f_intervaljoin()  1.779534
2       f_ifelse() 21.635221
3     f_casewhen() 21.336844</code></pre>
</div>
</div>
</section>
<section id="filter-vs-inner-join-speed" class="slide level2" data-visibility="uncounted">
<h2>Filter vs inner join speed</h2>
<ul>
<li>When limiting analysis to the classifications with at least 10 companies, it was quicker to reduce the main dataset by an <code>inner_join</code> than <code>filter</code></li>
</ul>
<div class="cell" data-hash="slides_cache/revealjs/unnamed-chunk-9_e7c70581750b24deee49bbcb07d25ba8">
<div class="cell-output cell-output-stdout">
<pre><code>            expr   median
1     f_filter() 339.3404
2 f_inner_join() 365.2718</code></pre>
</div>
</div>
<div class="footer footer-default">

</div>
</section></section>
    </div>
  </div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="slides_files/libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="slides_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="slides_files/libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="slides_files/libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="slides_files/libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="slides_files/libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="slides_files/libs/revealjs/plugin/notes/notes.js"></script>
  <script src="slides_files/libs/revealjs/plugin/search/search.js"></script>
  <script src="slides_files/libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="slides_files/libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'smaller': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1280,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    
    <script>
      // htmlwidgets need to know to resize themselves when slides are shown/hidden.
      // Fire the "slideenter" event (handled by htmlwidgets.js) when the current
      // slide changes (different for each slide format).
      (function () {
        // dispatch for htmlwidgets
        function fireSlideEnter() {
          const event = window.document.createEvent("Event");
          event.initEvent("slideenter", true, true);
          window.document.dispatchEvent(event);
        }

        function fireSlideChanged(previousSlide, currentSlide) {
          fireSlideEnter();

          // dispatch for shiny
          if (window.jQuery) {
            if (previousSlide) {
              window.jQuery(previousSlide).trigger("hidden");
            }
            if (currentSlide) {
              window.jQuery(currentSlide).trigger("shown");
            }
          }
        }

        // hookup for slidy
        if (window.w3c_slidy) {
          window.w3c_slidy.add_observer(function (slide_num) {
            // slide_num starts at position 1
            fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);
          });
        }

      })();
    </script>

    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button', {
        text: function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
        }
      });
      clipboard.on('success', function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "Copied!");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "Copied!");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      });
      function tippyHover(el, contentFn) {
        const config = {
          allowHTML: true,
          content: contentFn,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        };
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          return note.innerHTML;
        });
      }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    

</body></html>